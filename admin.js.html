<script>
const $ = s => document.querySelector(s);
const ME = (window.__ME__ || { prioridad: 0 });
const GLOBAL_CFG = window.__GLOBAL_CFG__ || {};
const ADMIN_ALL_ACCESS = !!window.__ADMIN_ALL_ACCESS__;
const ADMIN_IS_GENERAL = !!window.__ADMIN_IS_GENERAL__;
function collectAdminScopeRawIds(raw){
  const out = [];
  const seenObjects = new Set();
  const visit = (value) => {
    if (value == null) return;
    if (Array.isArray(value)){
      value.forEach(visit);
      return;
    }
    if (value instanceof Set){
      value.forEach(visit);
      return;
    }
    if (typeof value === 'object'){
      if (seenObjects.has(value)) return;
      seenObjects.add(value);
      if (Object.prototype.hasOwnProperty.call(value, 'value')) visit(value.value);
      if (Object.prototype.hasOwnProperty.call(value, 'id')) visit(value.id);
      Object.keys(value).forEach(key => {
        if (key === 'value' || key === 'id') return;
        try { visit(value[key]); } catch(e){}
      });
      return;
    }
    if (typeof value === 'string'){
      value.split(/[;,]/).forEach(part => {
        const token = part.trim();
        if (token) out.push(token);
      });
      return;
    }
    out.push(value);
  };
  visit(raw);
  return out;
}

const ADMIN_SCOPE_IDS = (() => {
  const ids = new Set();
  collectAdminScopeRawIds(window.__ADMIN_SCOPE_IDS__).forEach(token => {
    const normalized = String(token || '').trim();
    if (!normalized) return;
    const num = Number(normalized.replace(/^[^0-9]+/, '')) || Number(normalized) || 0;
    if (!num || !Number.isFinite(num)) return;
    ids.add(num);
  });
  return ids;
})();

function adminCanManageSalonFront(salonId){
  if (ADMIN_ALL_ACCESS) return true;
  const map = window.__SALON_ADMIN_IDS__ || {};
  const adminId = Number(map[String(salonId||'')] || 0);
  if (!adminId) return false;
  return ADMIN_SCOPE_IDS.has(adminId);
}
function getPrioridadSalonesAdmin(){
  const seen = {};
  const out = [];
  const candidates = [];
  if (Array.isArray(ME.prioridad_salones)) candidates.push(ME.prioridad_salones);
  if (Array.isArray(ME.prioridadSalones)) candidates.push(ME.prioridadSalones);
  candidates.forEach(list => {
    list.forEach(code => {
      const token = String(code||'').trim().toUpperCase();
      if (token && !seen[token]){ seen[token]=true; out.push(token); }
    });
  });
  if (!out.length && typeof ME.prioridad_salones_raw === 'string'){
    String(ME.prioridad_salones_raw||'').split(';').forEach(code => {
      const token = String(code||'').trim().toUpperCase();
      if (token && !seen[token]){ seen[token]=true; out.push(token); }
    });
  }
  return out;
}
function getEffectivePriorityForSalonAdmin(salonId){
  const base = Number(ME.prioridad) || 0;
  if (base <= 0) return base;
  const list = getPrioridadSalonesAdmin();
  if (!list.length) return base;
  const target = String(salonId||'').trim().toUpperCase();
  if (!target) return base;
  return list.includes(target) ? base : 0;
}

function getSalonConfigAdmin(salonId){
  const cfgMap = window.__SALON_CFG_ADMIN__ || {};
  const key = String(salonId||'');
  if (key && cfgMap[key]) return cfgMap[key];
  return GLOBAL_CFG;
}
const Busy = (()=>{ let n=0; const el=()=>$('#overlay'); return{ show(msg){const o=el(); if(!o) return; o.querySelector('.overlay-msg').textContent=msg||'Procesando…'; o.hidden=false; n++;}, hide(){const o=el(); if(!o) return; n=Math.max(0,n-1); if(!n) o.hidden=true;}, reset(){const o=el(); if(!o) return; n=0; o.hidden=true;} };})();
function modal(msg, title){ $('#mTitle').textContent=title||'Aviso'; $('#mBody').textContent=msg||''; $('#modal').hidden=false; $('#mOk').onclick=()=>$('#modal').hidden=true; }

let __CON_MAP__ = null; // { codigo: {nombre, email, ...} }
function loadConserjeMap(cb){
  if (__CON_MAP__) return cb && cb(__CON_MAP__);
  google.script.run
    .withSuccessHandler(r=>{
      const map = {};
      ((r&&r.data)||[]).forEach(c => { map[c.codigo] = c; });
      __CON_MAP__ = map;
      cb && cb(__CON_MAP__);
    })
    .withFailureHandler(()=>{ __CON_MAP__ = {}; cb && cb(__CON_MAP__); })
    .apiListConserjes();
}

function normalizeHHMM(str){
  const m = String(str||'').trim().match(/^(\d{1,2}):(\d{1,2})$/);
  if (!m) return '';
  const h = Math.max(0, Math.min(23, parseInt(m[1],10) || 0));
  const mi = Math.max(0, Math.min(59, parseInt(m[2],10) || 0));
  return `${String(h).padStart(2,'0')}:${String(mi).padStart(2,'0')}`;
}

function parseSalonRestrictionMeta(raw){
  const text = String(raw||'').trim();
  if (!text) return { intervals:[], requiresApproval:false, raw:'' };
  const parts = text.split(';').map(p=>String(p||'').trim()).filter(Boolean);
  const intervals = [];
  let requiresApproval = false;
  parts.forEach(part => {
    const up = part.toUpperCase();
    if (up === 'CONFIRM' || up === 'COFNIRM'){
      requiresApproval = true;
      return;
    }
    const match = part.match(/^(\d{1,2}:\d{2})\s*-\s*(\d{1,2}:\d{2})$/);
    if (!match) return;
    const ini = normalizeHHMM(match[1]);
    const fin = normalizeHHMM(match[2]);
    if (!ini || !fin || ini === fin) return;
    intervals.push(`${ini}-${fin}`);
  });
  return { intervals, requiresApproval, raw:text };
}

function applyAdminSalonMetaHints(){
  const select = document.getElementById('a-salon');
  const salonId = select ? select.value : '';
  const metaMap = (typeof window !== 'undefined' && window.__SALON_META_ADMIN__) || {};
  const meta = metaMap[salonId] || { intervals:[], requiresApproval:false };
  const restr = document.getElementById('a-restriccionHint');
  if (restr){
    if (meta.intervals && meta.intervals.length){
      restr.textContent = `Horarios restringidos: ${meta.intervals.join(', ')}`;
      restr.hidden = false;
    } else {
      restr.hidden = true;
      restr.textContent = '';
    }
  }
  const appr = document.getElementById('a-aprobacionHint');
  if (appr){
    if (meta.requiresApproval){
      appr.textContent = 'Este salón es restringido y requiere aprobación administrativa. Las solicitudes quedarán pendientes hasta aprobarlas.';
      appr.hidden = false;
    } else {
      appr.hidden = true;
      appr.textContent = '';
    }
  }
}

// ---- Fecha helpers ----
function todayYMD(){
  const d = new Date();
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,'0');
  const dd = String(d.getDate()).padStart(2,'0');
  return `${y}-${m}-${dd}`;
}
function addDaysYMD(startYmd, days){
  const [y,m,d] = startYmd.split('-').map(n=>parseInt(n,10));
  const dt = new Date(y, m-1, d);
  dt.setDate(dt.getDate() + (Number(days)||0));
  const yy = dt.getFullYear();
  const mm = String(dt.getMonth()+1).padStart(2,'0');
  const dd2 = String(dt.getDate()).padStart(2,'0');
  return `${yy}-${mm}-${dd2}`;
}
function setDefaultAdminRange(days=30){
  const f1 = $('#f1'), f2 = $('#f2');
  const start = todayYMD();
  const end   = addDaysYMD(start, days);
  if (f1) f1.value = start;
  if (f2) f2.value = end;
  // Evita rango inverso (como en “Mis reservas”)
  if (f1 && f2){
    f2.min = f1.value;
    f1.max = f2.value;
    f1.onchange = () => { f2.min = f1.value; if (f2.value && f2.value < f1.value) f2.value = f1.value; };
    f2.onchange = () => { f1.max = f2.value; if (f1.value && f1.value > f2.value) f1.value = f2.value; };
  }
}

function drawSalones(arr){
  const el = $('#salones');
  const list = ADMIN_ALL_ACCESS
    ? arr
    : arr.filter(s => s.admin_can_manage || adminCanManageSalonFront(s.id));
  if (!list.length){ el.innerHTML='<p>No hay salones configurados.</p>'; return; }
  const rows = list.map(s=>{
    const meta = parseSalonRestrictionMeta(s.restriccion);
    const parts = [];
    if (meta.intervals && meta.intervals.length){ parts.push(`Horarios: ${meta.intervals.join(', ')}`); }
    if (meta.requiresApproval){ parts.push('Requiere aprobación manual'); }
    const restr = parts.length ? parts.join('<br/>') : '—';
    return `<tr>
      <td>${s.id}</td><td>${s.nombre}</td><td>${s.capacidad}</td>
      <td>${restr}</td>
      <td>${s.habilitado?'<span class="tag">Habilitado</span>':'<span class="tag" style="background:#fee2e2;color:#991b1b">Deshabilitado</span>'}</td>
      <td><button data-id="${s.id}" data-act="${s.habilitado?'off':'on'}" class="btn-blue">${s.habilitado?'Deshabilitar':'Habilitar'}</button></td>
    </tr>`;
  }).join('');
  el.innerHTML = `<table class="table-center"><thead><tr><th>ID</th><th>Salón</th><th>Capacidad</th><th>Restricción</th><th>Estado</th><th></th></tr></thead><tbody>${rows}</tbody></table>`;
  el.querySelectorAll('button').forEach(b=> b.onclick = ()=> toggleSalon(b.dataset.id, b.dataset.act==='on'));
}
function toggleSalon(id, on){ Busy.show('Guardando…'); google.script.run
  .withSuccessHandler(r=>{ Busy.hide(); if(r&&r.ok){ loadSalones(); } else modal(r&&r.msg||'No se pudo actualizar'); })
  .withFailureHandler(e=>{ Busy.hide(); modal('Error al actualizar'); })
  .apiToggleSalon(id, on);
}

function drawReservas(arr){
  const el = $('#reservas');
  if (!arr.length){ el.innerHTML='<p>Sin resultados.</p>'; return; }
  const fmt12 = (hhmm)=>{ if (!/^\d{2}:\d{2}$/.test(hhmm||'')) return hhmm||''; let [h,m]=hhmm.split(':').map(Number); const am=h<12; h=(h%12)||12; return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')} ${am?'a.m.':'p.m.'}`; };
  const fmtDateDMY = (ymd)=>{ const [y,m,d]=(ymd||'').split('-'); return (y&&m&&d)? `${d}/${m}/${y}` : (ymd||''); };
  const now = new Date();
  const tooLate = (r)=>{ // true si no se permite actuar (pasado o <30min)
    try{
      const [hh,mi] = (r.hora_inicio||'00:00').split(':').map(Number);
      const dt = new Date(r.fecha+'T00:00:00'); dt.setHours(hh||0, mi||0, 0, 0);
      return now.getTime() > (dt.getTime() - 30*60*1000);
    }catch(e){ return false; }
  };
  const rows = arr.map(r=>{
    const fecha = fmtDateDMY(r.fecha);
    const hora  = `${fmt12(r.hora_inicio)} - ${fmt12(r.hora_fin)}`;
    const estStr = String(r.estado||'').toUpperCase();
    let estNic = estStr==='APROBADA'?'Aprobada':(estStr==='CANCELADA'?'Cancelada':(estStr==='PENDIENTE'?'Pendiente':r.estado||''));
    let estCls = estStr==='APROBADA'?'pill pill--ok':(estStr==='CANCELADA'?'pill pill--bad':(estStr==='PENDIENTE'?'pill pill--pending':'pill pill--other'));
    const late = tooLate(r);
    // Columna Conserje (reglas: no habilitar si cancelada o late)
    let colConserje = '';
    if (r.conserje_requerido==='SI'){
      if (estStr==='CANCELADA' || late){
        // Mostrar nombre si había asignado; si no, vacío
        if (r.conserje_codigo_asignado){
          const code = r.conserje_codigo_asignado;
          const name = (r.conserje_nombre && r.conserje_nombre.trim())
                      || (__CON_MAP__ && __CON_MAP__[code]?.nombre)
                      || code;
          colConserje = `<span>${name}</span>`;
        } else {
          colConserje = '';
        }
      } else {
        if (r.conserje_codigo_asignado){
          const code = r.conserje_codigo_asignado;
          const name = (r.conserje_nombre && r.conserje_nombre.trim())
                      || (__CON_MAP__ && __CON_MAP__[code]?.nombre)
                      || code;
          colConserje = `<a href="#" class="asignar-link" data-id="${r.id}">${name}</a>`;
        } else {
          colConserje = `<a href="#" class="asignar-link" data-id="${r.id}">Asignar</a>`;
        }
      }
    }
    let acciones = '';
    if (estStr==='APROBADA' && !late){
      acciones = `<button class="btn-blue" data-id="${r.id}" data-action="cancel">Cancelar</button>`;
    } else if (estStr==='PENDIENTE'){
      const approveBtn = `<button class="btn-blue" data-id="${r.id}" data-action="approve">Aprobar</button>`;
      const cancelBtn = `<button class="btn-blue btn--sm" data-id="${r.id}" data-action="cancel" data-pending="1">Cancelar</button>`;
      acciones = `<div style="display:flex;flex-direction:column;gap:6px;">${approveBtn}${cancelBtn}</div>`;
    }
    return `
      <tr>
        <td data-th="Fecha"><span class="val">${fecha}</span></td>
        <td data-th="Hora"><span class="val">${hora}</span></td>
        <td data-th="Salón"><span class="val">${r.salon_nombre}</span></td>
        <td data-th="Evento"><span class="val">${r.evento_nombre||''}</span></td>
        <td data-th="Solicitante"><span class="val">${r.solicitante_nombre} (${r.solicitante_email})</span></td>
      <td data-th="Estado"><span class="${estCls}">${estNic}</span></td>
        <td data-th="Conserje"><span class="val">${colConserje}</span></td>
        <td data-th=""><span class="val">${acciones}</span></td>
      </tr>`;
  }).join('');
  el.innerHTML = `
    <div class="cards-area">
      <table class="resp-table table-center">
        <thead>
          <tr>
            <th>Fecha</th><th>Hora</th><th>Salón</th><th>Evento</th><th>Solicitante</th><th>Estado</th><th>Conserje</th><th></th>
          </tr>
        </thead>
        <tbody>${rows}</tbody>
      </table>
    </div>`;

  // handlers
  el.querySelectorAll('button[data-action]').forEach(btn=>{
    const act = btn.dataset.action;
    if (act === 'cancel'){
      btn.onclick = ()=> cancelarAdmin(btn.dataset.id, btn.dataset.pending ? 'Cancelada por administración (pendiente)' : undefined);
    } else if (act === 'approve'){
      btn.onclick = ()=> aprobarAdmin(btn.dataset.id);
    }
  });
  el.querySelectorAll('a.asignar-link').forEach(a=> a.onclick = (e)=>{ e.preventDefault(); openAsignarModal(a.dataset.id); });
}

function cancelarAdmin(id, defaultMotivo){
  const motivo = prompt('Motivo de cancelación:', defaultMotivo || 'Cancelada por administración'); if (motivo===null) return;
  Busy.show('Cancelando…'); google.script.run
    .withSuccessHandler(r=>{ Busy.hide(); if(r&&r.ok){ buscar(); } else modal(r&&r.msg||'No se pudo cancelar'); })
    .withFailureHandler(e=>{ Busy.hide(); modal('Error al cancelar'); })
    .apiCancelarReservaAdmin(id, motivo);
}

function aprobarAdmin(id){
  Busy.show('Aprobando…');
  google.script.run
    .withSuccessHandler(r=>{
      Busy.hide();
      if (r && r.ok){
        modal(r.already ? 'La reserva ya estaba aprobada.' : 'Reserva aprobada.');
        buscar();
      } else {
        modal((r && r.msg) || 'No se pudo aprobar la reserva.');
      }
    })
    .withFailureHandler(()=>{ Busy.hide(); modal('Error al aprobar la reserva.'); })
    .apiAprobarReservaAdmin(id);
}

function loadSalones(){ google.script.run
  .withSuccessHandler(r=>{
    const data = ((r&&r.data)||[]);
    window.__SALON_CAPS__ = {};
    window.__SALON_META_ADMIN__ = {};
    window.__SALON_CFG_ADMIN__ = {};
    window.__SALON_ADMIN_IDS__ = {};
    data.forEach(s => {
      window.__SALON_CAPS__[s.id] = Number(s.capacidad)||0;
      window.__SALON_META_ADMIN__[s.id] = parseSalonRestrictionMeta(s.restriccion);
      window.__SALON_CFG_ADMIN__[s.id] = {
        HORARIO_INICIO: s.horario_inicio || GLOBAL_CFG.HORARIO_INICIO || '07:00',
        HORARIO_FIN: s.horario_fin || GLOBAL_CFG.HORARIO_FIN || '20:00',
        DUR_MIN: Number(s.duration_min || GLOBAL_CFG.DUR_MIN || 30),
        DUR_MAX: Number(s.duration_max || GLOBAL_CFG.DUR_MAX || 240),
        DUR_STEP: Number(s.duration_step || GLOBAL_CFG.DUR_STEP || 30)
      };
      window.__SALON_ADMIN_IDS__[s.id] = Number(s.administracion || 0) || 0;
    });
    drawSalones(data);
    // === NUEVO: poblar select del formulario Admin si existe ===
    const sel = document.getElementById('a-salon');
      if (sel){
        const opts = ['<option value="">[Seleccionar]</option>']
          .concat(data.map(s => `<option value="${s.id}" ${s.habilitado ? '' : 'disabled'}>${s.nombre}${s.habilitado?'':' (Deshabilitado)'}</option>`));
        sel.innerHTML = opts.join('');
        applyAdminSalonMetaHints();
        renderDurationsFromConfigAdmin(sel.value||'');
      }
    // limpia el tag de cap máx al cargar
    const tag = document.getElementById('a-capMaxTag');
    if (tag) tag.textContent = '';
  })
  .withFailureHandler(e=> modal('No se pudo cargar salones'))
  .apiListSalones();
}

function buscar(){
  const f1 = $('#f1').value || ''; const f2 = $('#f2').value || '';
  Busy.show('Buscando…'); google.script.run
    .withSuccessHandler(r=>{ Busy.hide(); drawReservas((r&&r.data)||[]); })
    .withFailureHandler(e=>{ Busy.hide(); modal('No se pudo cargar reservas'); })
    .apiListReservasAdmin(f1, f2);
}

function init(){
  Busy.reset();
  try{
    $('#logo').src = (window.__LOGO_URL__ || '');
  }catch(e){/* noop */}

  loadSalones();
  setDefaultAdminRange(30);
  loadConserjeMap(()=> buscar());
  $('#btnBuscar').onclick = buscar;
  const btnCon = document.getElementById('btnConserjes');
  if (btnCon){
    if (ADMIN_IS_GENERAL){
      btnCon.onclick = openConserjesModal;
    } else {
      btnCon.hidden = true;
    }
  }
  const btnUsers = document.getElementById('btnUsuarios');
  if (btnUsers){
    if (ADMIN_IS_GENERAL){
      btnUsers.onclick = openUsuariosModal;
    } else {
      btnUsers.hidden = true;
    }
  }

  // === Listeners de validación de capacidad en el formulario Admin ===
  const aSalon = document.getElementById('a-salon');
  const aCant  = document.getElementById('a-cant');
  if (aSalon){
    aSalon.addEventListener('change', ()=>{
      renderDurationsFromConfigAdmin(aSalon.value||'');
      applyAdminSalonMetaHints();
      scheduleRefreshSlotsAdmin();
      // actualiza tag y revalida
      const cap = (window.__SALON_CAPS__||{})[aSalon.value||''] || 0;
      const tag = document.getElementById('a-capMaxTag');
      if (tag) tag.textContent = cap ? `(máx ${cap})` : '';
      if (aCant){
        const n = Number(aCant.value||0);
        const bad = cap && n>cap;
        let capErr = document.getElementById('a-cantError');
        if (!capErr){
          capErr = document.createElement('small');
          capErr.id = 'a-cantError';
          capErr.className = 'error';
          aCant.insertAdjacentElement ? aCant.insertAdjacentElement('afterend', capErr) : aCant.parentNode.appendChild(capErr);
        }
        capErr.hidden = !bad;
        capErr.textContent = bad ? `La cantidad ingresada excede la capacidad máxima (${cap}).` : '';
        aCant.classList.toggle('input-error', bad);
      }
    });
  }
  if (aCant){
    aCant.addEventListener('input', ()=>{
      const cap = (window.__SALON_CAPS__||{})[(aSalon&&aSalon.value)||''] || 0;
      const n = Number(aCant.value||0);
      const bad = cap && n>cap;
      let capErr = document.getElementById('a-cantError');
      if (!capErr){
        capErr = document.createElement('small');
        capErr.id = 'a-cantError';
        capErr.className = 'error';
        aCant.insertAdjacentElement ? aCant.insertAdjacentElement('afterend', capErr) : aCant.parentNode.appendChild(capErr);
      }
      capErr.hidden = !bad;
      capErr.textContent = bad ? `La cantidad ingresada excede la capacidad máxima (${cap}).` : '';
      aCant.classList.toggle('input-error', bad);
    });
  }

  // ===== Crear reserva (Admin) =====
  bootCreateAdmin();
}

// ===== Crear reserva (Admin) =====
function bootCreateAdmin(){
  // Toggle anfitrión (default: “Sí” → autollenar con usuario en sesión vía Admin)
  (function(){
    const btnYes = document.getElementById('a-hostYes');
    const btnNo  = document.getElementById('a-hostNo');
    const fields = {
      nombre: document.getElementById('a-nombre'),
      email:  document.getElementById('a-email'),
      dep:    document.getElementById('a-dep'),
      ext:    document.getElementById('a-ext'),
    };
    // Datos del usuario en sesión expuestos por Admin.html
    const MEA = (window.__ME__ || {});
    function fillFromME(){
      if (fields.nombre) fields.nombre.value = (MEA.nombre||'').trim();
      if (fields.email)  fields.email.value  = (MEA.email||'').trim();
      if (fields.dep)    fields.dep.value    = (MEA.departamento||'').trim();
      if (fields.ext)    fields.ext.value    = (MEA.extension||'');
    }
    function clearHost(){
      Object.values(fields).forEach(el=>{ if (el) el.value=''; });
      const eHint = document.getElementById('a-emailError'); if (eHint) eHint.hidden = true;
      const xHint = document.getElementById('a-extError');   if (xHint) xHint.hidden = true;
    }
    function setPressed(yes){
      if (!btnYes || !btnNo) return;
      btnYes.setAttribute('aria-pressed', yes?'true':'false');
      btnNo.setAttribute('aria-pressed',  yes?'false':'true');
    }
    if (btnYes && btnNo){
      btnYes.onclick = ()=>{ setPressed(true); fillFromME(); };
      btnNo.onclick  = ()=>{ setPressed(false); clearHost(); };
      // Por defecto: Sí → autollenar desde BD
      setPressed(true);
      fillFromME();
    }
  })();

  // Dominio email en Admin
  (function(){
    const email = document.getElementById('a-email');
    const hint  = document.getElementById('a-emailError');
    const okDom = (v)=> /@infotep\.gob\.do$/i.test(String(v||'').trim());
    if (!email || !hint) return;
    email.addEventListener('blur', ()=>{
      const v = email.value;
      hint.hidden = !v || okDom(v);
    });
  })();

  // Prepara fecha mínima = hoy
  const today = new Date(); const y=today.getFullYear(), m=String(today.getMonth()+1).padStart(2,'0'), d=String(today.getDate()).padStart(2,'0');
  const ymd = `${y}-${m}-${d}`;
  const $f = $('#a-fecha'); if ($f){ $f.min = ymd; $f.value = ymd; }
  // Duraciones iniciales desde config global
  renderDurationsFromConfigAdmin('');
  // Eventos
  const fechaSel = $('#a-fecha');
  if (fechaSel) fechaSel.onchange = scheduleRefreshSlotsAdmin;
  const durSel = $('#a-dur');
  if (durSel) durSel.onchange = scheduleRefreshSlotsAdmin;
  const horaSel = $('#a-hora');
  if (horaSel) horaSel.onchange = verifySelectedSlotAdmin;
  $('#a-crear').onclick  = crearReservaAdmin;

  // Filtro de extensión (solo números) con hint
  const ext = $('#a-ext'), extErr = $('#a-extError');
  if (ext){
    ext.addEventListener('input', (e)=>{
      const before = e.target.value;
      const after  = before.replace(/\D+/g,'');
      const bad    = before !== after;
      if (bad) e.target.value = after;
      if (extErr){
        extErr.hidden = !(bad && before.length>0);
        e.target.classList.toggle('input-error', bad);
      }
    });
  }
  // Capacidad: título dinámico y hint al exceder (sin pedir al server)
  initSalonCapacityAdmin();
}

let _admReqSeq = 0;
function scheduleRefreshSlotsAdmin(){ clearTimeout(window.__admDeb__); window.__admDeb__=setTimeout(refreshSlotsAdmin, 200); }

function refreshSlotsAdmin(){
  const salon = $('#a-salon').value||'';
  const fecha = $('#a-fecha').value||'';
  const dur   = Number($('#a-dur').value||0);
  if(!salon||!fecha||!dur){
    $('#a-hora').innerHTML='';
    // limpia meta y hint si no hay salón/fecha/duración
    const tag = document.getElementById('a-capMaxTag');
    if (tag) tag.textContent = '';
    const capErr = document.getElementById('a-cantError');
    if (capErr){ capErr.hidden = true; capErr.textContent=''; }
    $('#a-cant')?.classList.remove('input-error');
    applyAdminSalonMetaHints();
    return;
  }

  const my = ++_admReqSeq;
  Busy.show('Verificando disponibilidad…');

  google.script.run
    .withSuccessHandler(r=>{
      if (my!==_admReqSeq) return;
      Busy.hide();

      const arr = (r && r.data) || [];

      // --- Filtrar horas pasadas cuando la fecha es hoy ---
      const todayYMD = (()=>{
        const d = new Date();
        const y = d.getFullYear();
        const m = String(d.getMonth()+1).padStart(2,'0');
        const dd= String(d.getDate()).padStart(2,'0');
        return `${y}-${m}-${dd}`;
      })();
      const isToday = fecha === todayYMD;
      const now     = new Date();
      const nowMin  = now.getHours()*60 + now.getMinutes();
      const toMin   = (hhmm)=>{ const [h,m] = String(hhmm||'').split(':').map(Number); return (h*60)+(m||0); };

      const filtered = arr.filter(s => !isToday || toMin(s.inicio) > nowMin);

      const opts = ['<option value="">[Seleccionar]</option>'].concat(filtered.map(s=>{
        const puede = !!s.seleccionable;
        let note = '';
        if (!s.disponible && s.maxPrio!=null){
          if (puede){
            note = ' (ocupado – puedes reasignar)';
          } else if (s.motivoConciliacion === 'PUBLICO_EXTERNO'){
            note = ' (evento externo – coordinar)';
          } else if (s.motivoConciliacion === 'MISMA_PRIORIDAD'){
            note = ' (reservado – coordinar)';
          } else {
            note = ' (reservado)';
          }
        }
        const esRestriccion = !!s.restringido || String(s.motivoRestriccion||'').toUpperCase()==='RESTRICCION';
        if (esRestriccion){ note = ' (horario restringido)'; }
        const disabledAttr = (!puede || esRestriccion) ? 'disabled' : '';
        return `<option value="${s.inicio}" ${disabledAttr}>${s.inicio} - ${s.fin}${note}</option>`;
      }));

      $('#a-hora').innerHTML = opts.join('');
      applyAdminSalonMetaHints();

      // === Actualizar el tag "(máx N)" en el label
      const tag = document.getElementById('a-capMaxTag');
      if (tag){
        const cap = (window.__SALON_CAPS__||{})[salon] || 0;
        tag.textContent = cap ? `(máx ${cap})` : '';
      }
      // Revalida cantidad actual contra la nueva capacidad
      const cantEl = document.getElementById('a-cant');
      if (cantEl){
        const cap = (window.__SALON_CAPS__||{})[salon] || 0;
        const n = Number(cantEl.value||0);
        const bad = cap && n>cap;
        let capErr = document.getElementById('a-cantError');
        if (!capErr){
          capErr = document.createElement('small');
          capErr.id = 'a-cantError';
          capErr.className = 'error';
          cantEl.insertAdjacentElement ? cantEl.insertAdjacentElement('afterend', capErr) : cantEl.parentNode.appendChild(capErr);
        }
        capErr.hidden = !bad;
        capErr.textContent = bad ? `La cantidad ingresada excede la capacidad máxima (${cap}).` : '';
        cantEl.classList.toggle('input-error', bad);
      }
    })
    .withFailureHandler(()=>{ Busy.hide(); modal('No se pudo obtener disponibilidad'); })
    .apiListDisponibilidad(fecha, salon, dur, getEffectivePriorityForSalonAdmin(salon));
}

function verifySelectedSlotAdmin(){
  const salon=$('#a-salon').value||''; const fecha=$('#a-fecha').value||''; const dur=Number($('#a-dur').value||0); const ini=$('#a-hora').value||'';
  if(!salon||!fecha||!dur||!ini) return;
  Busy.show('Confirmando intervalo…');
  google.script.run
    .withSuccessHandler(r=>{
      Busy.hide();
      if(!r||!r.ok) return;
      if(!r.disponible && !(2 > (r.maxPrio||0))){
        const motivo = String(r.motivo||'').toUpperCase();
        if (motivo === 'RESTRICCION'){
          modal('Este salón no permite reservas en el horario seleccionado. Elige otro intervalo.');
        } else {
          modal('Ese intervalo ya no está disponible.');
        }
        $('#a-hora').value='';
        scheduleRefreshSlotsAdmin();
      }
    })
    .withFailureHandler(()=>{ Busy.hide(); })
    .apiCheckSlot(fecha, salon, ini, dur, getEffectivePriorityForSalonAdmin(salon));
}
function crearReservaAdmin(){
  const p = {
    salon_id: $('#a-salon').value,
    fecha: $('#a-fecha').value,
    hora_inicio: $('#a-hora').value,
    duracion_min: Number($('#a-dur').value||0),
    nombre: $('#a-nombre').value.trim(),
    email: ($('#a-email').value||'').trim(),
    departamento: $('#a-dep').value.trim(),
    extension: $('#a-ext').value.trim(),
    cant_personas: $('#a-cant').value,
    evento_nombre: $('#a-evento').value.trim(),
    publico_tipo: $('#a-publico').value
  };
  if (!p.salon_id || !p.fecha || !p.hora_inicio || !p.duracion_min || !p.nombre || !p.email || !p.departamento || !p.extension || !p.cant_personas || !p.evento_nombre){
    return modal('Completa todos los campos obligatorios.');
  }
  if (!/@infotep\.gob\.do$/i.test(p.email||'')){
    const hint = document.getElementById('a-emailError'); if (hint) hint.hidden = false;
    return modal('El correo del anfitrión debe ser del dominio @infotep.gob.do');
  }
  Busy.show('Creando reserva…');
  google.script.run
    .withSuccessHandler(r=>{ Busy.hide(); if(r&&r.ok){
      const estado = String(r.estado||'').toUpperCase();
      if (estado === 'PENDIENTE' || r.requiere_aprobacion){
        modal('Solicitud registrada como pendiente. Revisa el historial para aprobarla cuando corresponda.');
      } else {
        modal('Reserva creada.');
      }
      buscar(); // refresca listado
      // reset rápido
      ['a-salon','a-hora','a-evento','a-nombre','a-email','a-dep','a-ext','a-cant'].forEach(id=>{ const el=document.getElementById(id); if(!el) return; el.value=''; });
      const df = document.getElementById('a-fecha'); if(df) df.value = df.min || df.value;
      applyAdminSalonMetaHints();
    } else { modal((r&&r.msg)||'No se pudo crear'); } })
    .withFailureHandler(()=>{ Busy.hide(); modal('Error al crear'); })
    .apiCrearReserva(p);
}
function renderDurationsFromConfigAdmin(salonId){
  const sel = $('#a-dur');
  if (!sel) return;
  const cfg = getSalonConfigAdmin(salonId);
  const min  = Number(cfg.DUR_MIN || GLOBAL_CFG.DUR_MIN || 30);
  const max  = Number(cfg.DUR_MAX || GLOBAL_CFG.DUR_MAX || 240);
  const step = Number(cfg.DUR_STEP || GLOBAL_CFG.DUR_STEP || 30) || 30;
  const prev = sel.value;
  const opts = ['<option value="">[Seleccionar]</option>'];
  const validValues = new Set();
  for (let d=min; d<=max; d+=step){
    const label = (d<60)? `${d} minutos` : (d%60===0? `${d/60} ${d===60?'hora':'horas'}` : `${Math.floor(d/60)} horas ${d%60} min`);
    opts.push(`<option value="${d}">${label}</option>`);
    validValues.add(String(d));
  }
  sel.innerHTML = opts.join('');
  if (prev && validValues.has(String(prev))){
    sel.value = prev;
  } else {
    sel.value = '';
  }
}

// ===== Capacidad (Admin) =====
let __SALON_MAP_ADMIN__ = {}; // { id: {capacidad, nombre} }
function initSalonCapacityAdmin(){
  // Construye mapa local de capacidades
  google.script.run
    .withSuccessHandler(r=>{
      const data = (r&&r.data)||[];
      __SALON_MAP_ADMIN__ = {};
      data.forEach(s=>{ __SALON_MAP_ADMIN__[s.id] = { cap: Number(s.capacidad||0), nombre: s.nombre }; });
      syncCapLabelAdmin();
      hookCantValidationAdmin();
    })
    .withFailureHandler(()=>{ __SALON_MAP_ADMIN__ = {}; syncCapLabelAdmin(); hookCantValidationAdmin(); })
    .apiListSalones();
  $('#a-salon').addEventListener('change', syncCapLabelAdmin);

  // También esconder hint al cambiar de salón
  const err = document.getElementById('a-cantError');
  if (err) err.hidden = true;
}
function maxCapForSalonAdmin(){
  const id = $('#a-salon').value||'';
  const rec = __SALON_MAP_ADMIN__[id];
  return rec && rec.cap ? Number(rec.cap) : 0;
}
function syncCapLabelAdmin(){
  const cap = maxCapForSalonAdmin();
  const lab = $('#a-cantLabel');
  if (!lab) return;
  if (cap>0) lab.textContent = `Cant. de personas (máx ${cap})`;
  else lab.textContent = 'Cant. de personas';
}
function hookCantValidationAdmin(){
  const cant = $('#a-cant'), err = $('#a-cantError');
  if (!cant || !err) return;
  // Al cargar, asegúrate de ocultar el hint
  err.hidden = true;
  const check = ()=>{
    const cap = maxCapForSalonAdmin();
    const val = Number(cant.value||0);
    if (!cant.value){ err.hidden = true; return; } // vacío → sin hint
    if (cap>0 && val>cap){
      err.textContent = `Excede la capacidad del salón (máx ${cap}).`;
      err.hidden = false;
    } else {
      err.hidden = true;
    }
  };
  cant.addEventListener('input', check);
  $('#a-salon').addEventListener('change', check);
  // También: si cambias de salón, resetea valor y label si quieres (opcional)
  // $('#a-cant').value = '';
}

// ===== Usuarios (modal) =====
function openUsuariosModal(){
  if (!ADMIN_IS_GENERAL){ window.modal('No autorizado'); return; }
  const modal = document.getElementById('modalUsers');
  const listEl = document.getElementById('users-list');
  let selected = null; // objeto usuario seleccionado
  const draw = (items=[])=>{
    if (!items.length){ listEl.innerHTML = '<p style="padding:10px">No hay usuarios.</p>'; return; }
    const rows = items.map(u=>{
      const adminId = Number(u.administracion||0) || 0;
      const adminLabel = adminId ? `ADMIN${adminId}` : '—';
      return `
      <tr class="u-row" data-email="${u.email}">
        <td>${u.nombre||'(sin nombre)'}<div class="muted" style="font-size:12px">${u.email}</div></td>
        <td>${u.departamento||''}</td>
        <td><span class="tag">${u.rol||''}</span></td>
        <td>${Number(u.prioridad||0)}</td>
        <td>${u.prioridad_salones||''}</td>
        <td>${u.estado||''}</td>
        <td>${u.extension||''}</td>
        <td>${adminLabel}</td>
      </tr>`;
    }).join('');
    listEl.innerHTML = `<table><thead><tr><th>Nombre / Correo</th><th>Departamento</th><th>Rol</th><th>Prioridad</th><th>Salones con prioridad</th><th>Estado</th><th>Ext.</th><th>Administración</th></tr></thead><tbody>${rows}</tbody></table>`;
    // selección
    listEl.querySelectorAll('.u-row').forEach(tr=>{
      tr.onclick = ()=>{
        const em = tr.dataset.email;
        if (selected && selected.email===em){
          selected=null; tr.classList.remove('selected');
          clearUserForm();
          return;
        }
        listEl.querySelectorAll('.u-row').forEach(x=>x.classList.remove('selected'));
        tr.classList.add('selected');
        const row = items.find(x=>x.email===em);
        selected = row||null;
        fillUserForm(row);
      };
    });
  };
  const modalMsg = (s)=>{ window.modal(s); };
  const clearUserForm = ()=>{
    ['u-email','u-nombre','u-dep','u-prio','u-prio-salones','u-ext','u-rol'].forEach(id=>{ const el=document.getElementById(id); if(el) el.value=''; });
    const r = document.getElementById('u-rol'); if(r) r.value='';
    const e = document.getElementById('u-estado'); if(e) e.value='';
  };
  const fillUserForm = (u)=>{
    document.getElementById('u-email').value = u?.email||'';
    document.getElementById('u-nombre').value = u?.nombre||'';
    document.getElementById('u-dep').value = u?.departamento||'';
    document.getElementById('u-rol').value = u?.rol||'';
    document.getElementById('u-prio').value = Number(u?.prioridad||0);
    document.getElementById('u-prio-salones').value = u?.prioridad_salones||'';
    document.getElementById('u-estado').value = u?.estado||'';
    document.getElementById('u-ext').value = u?.extension||'';
  };
  const load = ()=>{
    Busy.show('Cargando usuarios…');
    google.script.run
      .withSuccessHandler(r=>{ Busy.hide(); if(!r || !r.ok){ modalMsg((r&&r.msg)||'No se pudieron cargar usuarios'); return; } draw(r.data||[]); })
      .withFailureHandler(()=>{ Busy.hide(); modalMsg('No se pudieron cargar usuarios'); })
      .apiListUsuarios();
  };
  document.getElementById('u-save').onclick = ()=>{
    const payload = {
      email:    document.getElementById('u-email').value.trim(),
      nombre:   document.getElementById('u-nombre').value.trim(),
      departamento: document.getElementById('u-dep').value.trim(),
      rol:      document.getElementById('u-rol').value.trim(),
      prioridad:Number(document.getElementById('u-prio').value||0),
      prioridad_salones: document.getElementById('u-prio-salones').value.trim(),
      estado:   document.getElementById('u-estado').value.trim(),
      extension:document.getElementById('u-ext').value.trim()
    };
    if (!payload.email) return modalMsg('Correo es obligatorio.');
    // Si hay selección y no hay cambios → no-op
    if (selected &&
        selected.email===payload.email &&
        (selected.nombre||'')===payload.nombre &&
        (selected.departamento||'')===payload.departamento &&
        (selected.rol||'')===payload.rol &&
        Number(selected.prioridad||0)===payload.prioridad &&
        (String(selected.prioridad_salones||'').trim()===payload.prioridad_salones) &&
        (selected.estado||'')===payload.estado &&
        (selected.extension||'')===payload.extension){
      clearUserForm();
      const rows = listEl.querySelectorAll('.u-row'); rows.forEach(x=>x.classList.remove('selected')); selected=null;
      return modalMsg('No hay cambios que guardar.');
    }
    Busy.show(selected?'Guardando cambios…':'Guardando…');
    google.script.run
      .withSuccessHandler(r=>{ Busy.hide(); if(!r||!r.ok){ modalMsg(r&&r.msg||'No se pudo guardar'); return; } 
        clearUserForm();
        listEl.querySelectorAll('.u-row').forEach(x=>x.classList.remove('selected')); selected=null;
        load();
      })
      .withFailureHandler(()=>{ Busy.hide(); modalMsg('Error al guardar'); })
      .apiUpsertUsuario(payload);
  };
  document.getElementById('u-close').onclick = ()=> modal.hidden = true;
  modal.hidden = false;
  load();
}

// Lógica modal conserjes y asignar conserjes

function openConserjesModal(){
  if (!ADMIN_IS_GENERAL){ window.modal('No autorizado'); return; }
  const modalEl = document.getElementById('modalCon');
  const listEl  = document.getElementById('con-list');

  let selected = null;     // {codigo,nombre,email,telefono,activo} o null
  let snapshot = {};       // { codigo: conserje }

  const clearForm = ()=>{
    document.getElementById('con-nombre').value = '';
    document.getElementById('con-email').value  = '';
    document.getElementById('con-tel').value    = '';
  };

  const clearSelection = ()=>{
    selected = null;
    listEl.querySelectorAll('.con-row').forEach(x=>x.classList.remove('selected'));
  };

  const draw = (items=[])=>{
    if (!items.length){
      listEl.innerHTML = '<p style="padding:10px">No hay conserjes.</p>';
      return;
    }

    const rows = items.map(c => `
      <tr class="con-row" data-codigo="${c.codigo}">
        <td style="width:110px"><code>${c.codigo}</code></td>
        <td>${c.nombre}</td>
        <td>${c.email}</td>
        <td>${c.telefono||''}</td>
        <td>${c.activo?'<span class="tag">Activo</span>':'<span class="tag" style="background:#fee2e2;color:#991b1b">Inactivo</span>'}</td>
        <td style="width:120px">${c.activo? `<button class="btn btn-blue btn--sm con-del" data-codigo="${c.codigo}">Desactivar</button>` : ''}</td>
      </tr>
    `).join('');

    listEl.innerHTML = `
      <table>
        <thead><tr><th>Código</th><th>Nombre</th><th>Email</th><th>Teléfono</th><th>Estado</th><th></th></tr></thead>
        <tbody>${rows}</tbody>
      </table>`;

    // Selección + autollenado
    listEl.querySelectorAll('.con-row').forEach(tr=>{
      tr.onclick = ()=>{
        const codigo = tr.dataset.codigo;
        if (selected && selected.codigo === codigo){
          // Toggle off
          tr.classList.remove('selected');
          clearSelection();
          clearForm();
          return;
        }
        // Nueva selección
        listEl.querySelectorAll('.con-row').forEach(x=>x.classList.remove('selected'));
        tr.classList.add('selected');
        const row = items.find(x => x.codigo === codigo);
        selected = row || null;
        document.getElementById('con-nombre').value = row?.nombre || '';
        document.getElementById('con-email').value  = row?.email || '';
        document.getElementById('con-tel').value    = row?.telefono || '';
      };
    });

    // Desactivar (lógico)
    listEl.querySelectorAll('.con-del').forEach(b=>{
      b.onclick = (ev)=>{
        ev.stopPropagation();
        Busy.show('Actualizando…');
        google.script.run
          .withSuccessHandler(r=>{
            Busy.hide();
            if (!r || !r.ok){ window.modal('No se pudo actualizar'); return; }
            clearSelection();
            clearForm();
            load();
          })
          .withFailureHandler(()=>{
            Busy.hide();
            window.modal('Error');
          })
          .apiDeleteConserje(b.dataset.codigo);
      };
    });
  };

  const load = ()=>{
    Busy.show('Cargando…');
    google.script.run
      .withSuccessHandler(r=>{
        Busy.hide();
        const data = (r && r.data) || [];
        snapshot = {};
        data.forEach(c => { snapshot[c.codigo] = c; });
        draw(data);
      })
      .withFailureHandler(()=>{
        Busy.hide();
        window.modal('No se pudo cargar conserjes');
      })
      .apiListConserjes();
  };

  // Guardar = agregar o actualizar (según haya selección)
  document.getElementById('con-save').onclick = ()=>{
    const nombre = (document.getElementById('con-nombre').value||'').trim();
    const email  = (document.getElementById('con-email').value||'').trim().toLowerCase();
    const tel    = (document.getElementById('con-tel').value||'').trim();
    if (!nombre || !email) return window.modal('Nombre y correo son obligatorios');

    if (!selected){
      // Alta
      Busy.show('Agregando…');
      google.script.run
        .withSuccessHandler(r=>{
          Busy.hide();
          if (!r || !r.ok){ window.modal('No se pudo agregar'); return; }
          window.modal('Conserje agregado');
          clearForm();
          clearSelection();
          load();
        })
        .withFailureHandler(()=>{
          Busy.hide();
          window.modal('Error al agregar');
        })
        .apiAddConserje(nombre, email, tel);
      return;
    }

    // Edición (dif contra snapshot para escribir solo si cambia)
    const cur = snapshot[selected.codigo] || {};
    const fields = {};
    if ((cur.nombre||'')   !== nombre) fields.nombre   = nombre;
    if ((cur.email||'').toLowerCase() !== email) fields.email = email;
    if ((cur.telefono||'') !== tel)     fields.telefono = tel;

    if (Object.keys(fields).length === 0){
      window.modal('No hay cambios por guardar.');
      clearForm();
      clearSelection();
      return;
    }

    Busy.show('Guardando cambios…');
    google.script.run
      .withSuccessHandler(r=>{
        Busy.hide();
        if (!r || !r.ok){ window.modal((r && r.msg) || 'No se pudo guardar'); return; }
        window.modal(r.changed ? 'Cambios guardados' : 'No había cambios por guardar');
        clearForm();
        clearSelection();
        load();
      })
      .withFailureHandler(()=>{
        Busy.hide();
        window.modal('Error al guardar cambios');
      })
      .apiUpdateConserje(selected.codigo, fields);
  };

  document.getElementById('con-close').onclick = ()=> { modalEl.hidden = true; };
  modalEl.hidden = false;
  load();
}

let asignarReservaId = null;

function openAsignarModal(reservaId){
  asignarReservaId = reservaId;
  const modal = document.getElementById('modalAsignar');
  const sel = document.getElementById('selConserje');
  sel.innerHTML = '<option value="">[Seleccionar]</option>';
  Busy.show('Cargando conserjes…');
  google.script.run
    .withSuccessHandler(r=>{
      Busy.hide();
      const data = (r&&r.data)||[];
      sel.innerHTML = '<option value="">[Seleccionar]</option>' +
        data.filter(c=>c.activo).map(c=>`<option value="${c.codigo}">${c.nombre} (${c.codigo})</option>`).join('');
      modal.hidden = false;
    })
    .withFailureHandler(()=>{ Busy.hide(); modal('No se pudo cargar conserjes'); })
    .apiListConserjes();

  document.getElementById('btnAsignarOk').onclick = ()=>{
    const codigo = sel.value || '';
    if (!codigo) return modal('Selecciona un conserje');
    Busy.show('Asignando…');
    google.script.run
      .withSuccessHandler(r=>{
        Busy.hide();
        if (!r || !r.ok) { window.modal((r&&r.msg)||'No se pudo asignar'); return; }
        modal.hidden = true;
        // 1) Update inline inmediato
        const link = document.querySelector(`a.asignar-link[data-id="${asignarReservaId}"]`);
        if (link && r.conserje && r.conserje.nombre){
          link.textContent = r.conserje.nombre;
        }
        // 2) Refrescar fuentes para siguientes renders
        __CON_MAP__ = null;
        loadConserjeMap(()=> buscar());
      })
      .withFailureHandler(()=>{ Busy.hide(); window.modal('Error al asignar'); })
      .apiAsignarConserje(asignarReservaId, codigo);
  };
  document.getElementById('btnAsignarClose').onclick = ()=>{ modal.hidden = true; };
}

document.addEventListener('DOMContentLoaded', init);
</script>