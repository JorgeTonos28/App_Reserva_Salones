<script>
const $ = s => document.querySelector(s);
const ME = (window.__ME__ || { prioridad: 0 });
const ADMIN_SCOPE = String((ME && (ME.administracion_id || ME.admin_id || ME.adminScope || '1')) || '1').trim() || '1';
const IS_GENERAL_ADMIN = ADMIN_SCOPE === '1';
const CON_UNASSIGNED = window.__CON_UNASSIGNED__ || '__UNASSIGNED__';
let __SALONES_ALL__ = [];
let __SALONES_MANAGE__ = [];
let __SALON_CFG_MAP__ = {};
let __SLOT_INFO_ADMIN__ = {};
let __LAST_HIST_FILTERS__ = {};
let __PRESET_APPLIED__ = false;
let __HOST_FORM_ADMIN__ = null;
const DEFAULT_DUR_CFG = {
  min: Number(window.__DUR_MIN__ || 30),
  max: Number(window.__DUR_MAX__ || 240),
  step: Number(window.__DUR_STEP__ || 30)
};
function escHtml(str){
  return String(str || '').replace(/[&<>"']/g, ch => ({
    '&': '&amp;',
    '<': '&lt;',
    '>': '&gt;',
    '"': '&quot;',
    "'": '&#39;'
  }[ch] || ch));
}
function isPublicoExternoOMixto(tipo){
  const t = String(tipo || '').trim().toLowerCase();
  return t === 'externo' || t === 'mixto';
}
function getPrioridadSalonesAdmin(){
  const seen = {};
  const out = [];
  const candidates = [];
  if (Array.isArray(ME.prioridad_salones)) candidates.push(ME.prioridad_salones);
  if (Array.isArray(ME.prioridadSalones)) candidates.push(ME.prioridadSalones);
  candidates.forEach(list => {
    list.forEach(code => {
      const token = String(code||'').trim().toUpperCase();
      if (token && !seen[token]){ seen[token]=true; out.push(token); }
    });
  });
  if (!out.length && typeof ME.prioridad_salones_raw === 'string'){
    String(ME.prioridad_salones_raw||'').split(';').forEach(code => {
      const token = String(code||'').trim().toUpperCase();
      if (token && !seen[token]){ seen[token]=true; out.push(token); }
    });
  }
  return out;
}
function getEffectivePriorityForSalonAdmin(salonId){
  const base = Number(ME.prioridad) || 0;
  if (base <= 0) return base;
  const list = getPrioridadSalonesAdmin();
  if (!list.length) return base;
  const target = String(salonId||'').trim().toUpperCase();
  if (!target) return base;
  return list.includes(target) ? base : 0;
}

function createHostFormController(opts){
  const fields = opts.fields || {};
  const errors = opts.errorHints || {};
  const listEl = opts.listEl || null;
  const meData = opts.me || {};
  const state = {
    isSession: true,
    results: [],
    timer: 0,
    pendingKey: '',
    pendingRaw: '',
    selected: null,
    enabled: false,
    loadingTimer: 0
  };
  const minQueryLen = 2;
  const queryCache = Object.create(null);
  const fetchDelay = 220;
  const loaderDelay = 1000;

  function hideErrors(){
    if (errors.email) errors.email.hidden = true;
    if (errors.ext) errors.ext.hidden = true;
    if (fields.ext) fields.ext.classList.remove('input-error');
  }

  function fillFromSession(){
    if (fields.nombre) fields.nombre.value = (meData.nombre || '').trim();
    if (fields.email) fields.email.value = (meData.email || '').trim();
    if (fields.dep) fields.dep.value = (meData.departamento || '').trim();
    if (fields.ext) fields.ext.value = String(meData.extension || '');
    hideErrors();
  }

  function clearFields(){
    if (fields.nombre) fields.nombre.value = '';
    if (fields.email) fields.email.value = '';
    if (fields.dep) fields.dep.value = '';
    if (fields.ext) fields.ext.value = '';
    hideErrors();
  }

  function clearLoadingIndicator(){
    clearTimeout(state.loadingTimer);
    if (listEl){
      delete listEl.dataset.loading;
    }
  }

  function showLoadingIndicator(){
    if (!listEl) return;
    listEl.dataset.loading = '1';
    listEl.innerHTML = '<div class="host-suggestions__loading"><i class="fa-solid fa-spinner fa-spin" aria-hidden="true"></i><span>Buscando coincidencias…</span></div>';
    listEl.hidden = false;
  }

  function hideSuggestions(){
    if (listEl){
      clearLoadingIndicator();
      listEl.innerHTML = '';
      listEl.hidden = true;
    }
    state.pendingKey = '';
    state.pendingRaw = '';
  }

  function render(list){
    if (!listEl) return;
    clearLoadingIndicator();
    if (!list || !list.length){
      listEl.innerHTML = '<div class="host-suggestions__empty">Sin coincidencias</div>';
      listEl.hidden = false;
      return;
    }
    const items = list.map((item, idx) => `
      <button type="button" class="host-suggestion" data-index="${idx}" role="option">
        <span class="host-suggestion__name">${escHtml(item.nombre || item.email || '(sin nombre)')}</span>
        <span class="host-suggestion__email">${escHtml(item.email || '')}</span>
        <span class="host-suggestion__dept">${escHtml(item.departamento || 'Sin departamento')}</span>
      </button>
    `).join('');
    listEl.innerHTML = items;
    listEl.hidden = false;
  }

  function applySelection(item){
    if (!item) return;
    if (fields.nombre) fields.nombre.value = item.nombre || item.email || '';
    if (fields.email) fields.email.value = item.email || '';
    if (fields.dep) fields.dep.value = item.departamento || '';
    if (fields.ext) fields.ext.value = item.extension || '';
    state.selected = item;
    hideErrors();
    hideSuggestions();
  }

  function buildHaystack(item){
    return [item.nombre || '', item.email || '', item.departamento || '']
      .join(' ')
      .toLowerCase();
  }

  function cacheResults(key, list){
    if (!key) return list;
    queryCache[key] = list;
    return list;
  }

  function fetch(query, key){
    google.script.run
      .withSuccessHandler(res => {
        if (state.pendingKey !== key) return;
        clearLoadingIndicator();
        const arr = (res && res.ok && Array.isArray(res.data)) ? res.data : [];
        const augmented = arr.map(item => ({ ...item, __haystack: buildHaystack(item) }));
        state.results = augmented;
        cacheResults(key, augmented);
        render(augmented);
      })
      .withFailureHandler(() => {
        if (state.pendingKey !== key) return;
        clearLoadingIndicator();
        state.results = [];
        render([]);
      })
      .apiBuscarAnfitriones(query);
  }

  function schedule(query){
    clearTimeout(state.timer);
    clearTimeout(state.loadingTimer);
    if (!state.enabled){
      hideSuggestions();
      return;
    }
    const normalized = String(query || '').trim();
    if (!normalized || normalized.replace(/\s+/g,'').length < minQueryLen){
      hideSuggestions();
      state.results = [];
      return;
    }
    const key = normalized.toLowerCase();
    state.pendingKey = key;
    state.pendingRaw = normalized;

    if (queryCache[key]){
      state.results = queryCache[key];
      render(state.results);
      return;
    }

    const tokens = key.split(/\s+/).filter(Boolean);
    if (tokens.length){
      let best = null;
      Object.keys(queryCache).forEach(cachedKey => {
        if (!cachedKey || key.length < cachedKey.length) return;
        if (!key.startsWith(cachedKey)) return;
        const base = queryCache[cachedKey];
        if (!Array.isArray(base)) return;
        const filtered = base.filter(item => {
          const hay = (item && item.__haystack) || '';
          return tokens.every(tok => hay.indexOf(tok) >= 0);
        });
        if (key !== cachedKey){
          cacheResults(key, filtered);
        }
        if (!best || filtered.length > best.length){
          best = filtered;
        }
      });
      if (best){
        state.results = best;
        render(best);
        return;
      }
    }

    state.loadingTimer = setTimeout(()=>{
      if (state.pendingKey === key){
        showLoadingIndicator();
      }
    }, loaderDelay);

    state.timer = setTimeout(()=> fetch(normalized, key), fetchDelay);
  }

  function setPressed(yes){
    const btnYes = opts.toggleYes;
    const btnNo = opts.toggleNo;
    if (!btnYes || !btnNo) return;
    btnYes.setAttribute('aria-pressed', yes ? 'true' : 'false');
    btnNo.setAttribute('aria-pressed', yes ? 'false' : 'true');
  }

  function setSessionMode(flag){
    state.isSession = !!flag;
    if (state.isSession){
      state.enabled = false;
      state.selected = null;
      hideSuggestions();
      fillFromSession();
    } else {
      state.enabled = true;
      state.selected = null;
      clearFields();
      if (fields.nombre) fields.nombre.focus();
    }
    setPressed(state.isSession);
  }

  function handleNombreInput(){
    if (state.isSession) return;
    const value = (fields.nombre && fields.nombre.value || '').trim();
    schedule(value);
  }

  if (opts.toggleYes) opts.toggleYes.onclick = () => setSessionMode(true);
  if (opts.toggleNo) opts.toggleNo.onclick = () => setSessionMode(false);

  const nombreEl = fields.nombre;
  if (nombreEl){
    nombreEl.addEventListener('input', ()=>{ state.selected = null; handleNombreInput(); });
    nombreEl.addEventListener('focus', ()=>{
      if (!state.isSession && state.results.length && listEl){
        listEl.hidden = false;
      }
    });
  }
  if (fields.email) fields.email.addEventListener('input', ()=>{ state.selected = null; });
  if (fields.dep) fields.dep.addEventListener('input', ()=>{ state.selected = null; });
  if (fields.ext) fields.ext.addEventListener('input', ()=>{ state.selected = null; });

  if (listEl){
    listEl.addEventListener('click', ev => {
      const btn = ev.target.closest('.host-suggestion');
      if (!btn) return;
      ev.preventDefault();
      const idx = Number(btn.getAttribute('data-index'));
      const item = state.results[idx];
      if (item) applySelection(item);
    });
  }

  document.addEventListener('click', ev => {
    if (!listEl || listEl.hidden) return;
    const target = ev.target;
    if ((listEl.contains && listEl.contains(target)) || (nombreEl && nombreEl === target)){
      return;
    }
    hideSuggestions();
  });

  setSessionMode(true);

  return {
    isSessionHost(){ return state.isSession; },
    selectedHost(){ return state.selected; },
    reset(){ setSessionMode(true); },
    manual(){ setSessionMode(false); },
    hideSuggestions
  };
}
const Busy = (()=>{ let n=0; const el=()=>$('#overlay'); return{ show(msg){const o=el(); if(!o) return; o.querySelector('.overlay-msg').textContent=msg||'Procesando…'; o.hidden=false; n++;}, hide(){const o=el(); if(!o) return; n=Math.max(0,n-1); if(!n) o.hidden=true;}, reset(){const o=el(); if(!o) return; n=0; o.hidden=true;} };})();
function modal(msg, title, opts){
  $('#mTitle').textContent = title || 'Aviso';
  const body = $('#mBody');
  if (body){
    if (opts && opts.html){
      body.innerHTML = msg || '';
    } else {
      body.textContent = msg || '';
    }
  }
  $('#modal').hidden = false;
  $('#mOk').onclick = ()=> $('#modal').hidden = true;
}

let __CON_MAP__ = null; // { codigo: {nombre, email, ...} }
function loadConserjeMap(cb){
  if (__CON_MAP__) return cb && cb(__CON_MAP__);
  google.script.run
    .withSuccessHandler(r=>{
      const map = {};
      ((r&&r.data)||[]).forEach(c => { map[c.codigo] = c; });
      __CON_MAP__ = map;
      cb && cb(__CON_MAP__);
    })
    .withFailureHandler(()=>{ __CON_MAP__ = {}; cb && cb(__CON_MAP__); })
    .apiListConserjes();
}

function normalizeHHMM(str){
  const m = String(str||'').trim().match(/^(\d{1,2}):(\d{1,2})$/);
  if (!m) return '';
  const h = Math.max(0, Math.min(23, parseInt(m[1],10) || 0));
  const mi = Math.max(0, Math.min(59, parseInt(m[2],10) || 0));
  return `${String(h).padStart(2,'0')}:${String(mi).padStart(2,'0')}`;
}

function hhmmToMinutes(str){
  const m = String(str||'').trim().match(/^(\d{1,2}):(\d{1,2})$/);
  if (!m) return NaN;
  const h = parseInt(m[1], 10) || 0;
  const mi = parseInt(m[2], 10) || 0;
  return (Math.max(0, h) * 60) + Math.max(0, Math.min(59, mi));
}

function normalizeAdminIdClient(val){
  const raw = String(val||'').trim();
  if (!raw) return '1';
  const num = Number(raw);
  if (isFinite(num) && num > 0){
    return String(Math.floor(num));
  }
  return raw;
}

function parseSalonRestrictionMeta(raw){
  const text = String(raw||'').trim();
  if (!text) return { intervals:[], requiresApproval:false, raw:'' };
  const parts = text.split(';').map(p=>String(p||'').trim()).filter(Boolean);
  const intervals = [];
  let requiresApproval = false;
  parts.forEach(part => {
    const up = part.toUpperCase();
    if (up === 'CONFIRM' || up === 'COFNIRM'){
      requiresApproval = true;
      return;
    }
    const match = part.match(/^(\d{1,2}:\d{2})\s*-\s*(\d{1,2}:\d{2})$/);
    if (!match) return;
    const ini = normalizeHHMM(match[1]);
    const fin = normalizeHHMM(match[2]);
    if (!ini || !fin || ini === fin) return;
    intervals.push(`${ini}-${fin}`);
  });
  return { intervals, requiresApproval, raw:text };
}

function applyAdminSalonMetaHints(){
  const select = document.getElementById('a-salon');
  const salonId = select ? select.value : '';
  const metaMap = (typeof window !== 'undefined' && window.__SALON_META_ADMIN__) || {};
  const meta = metaMap[salonId] || { intervals:[], requiresApproval:false };
  const restr = document.getElementById('a-restriccionHint');
  if (restr){
    if (meta.intervals && meta.intervals.length){
      restr.textContent = `Horarios restringidos: ${meta.intervals.join(', ')}`;
      restr.hidden = false;
    } else {
      restr.hidden = true;
      restr.textContent = '';
    }
  }
  const appr = document.getElementById('a-aprobacionHint');
  if (appr){
    if (meta.requiresApproval){
      appr.textContent = 'Este salón es restringido y requiere aprobación administrativa. Las solicitudes quedarán pendientes hasta aprobarlas.';
      appr.hidden = false;
    } else {
      appr.hidden = true;
      appr.textContent = '';
    }
  }
}

// ---- Fecha helpers ----
function todayYMD(){
  const d = new Date();
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,'0');
  const dd = String(d.getDate()).padStart(2,'0');
  return `${y}-${m}-${dd}`;
}
function addDaysYMD(startYmd, days){
  const [y,m,d] = startYmd.split('-').map(n=>parseInt(n,10));
  const dt = new Date(y, m-1, d);
  dt.setDate(dt.getDate() + (Number(days)||0));
  const yy = dt.getFullYear();
  const mm = String(dt.getMonth()+1).padStart(2,'0');
  const dd2 = String(dt.getDate()).padStart(2,'0');
  return `${yy}-${mm}-${dd2}`;
}
function syncHistorialDateBounds(){
  const f1 = $('#f1'), f2 = $('#f2');
  if (!f1 || !f2) return;
  f2.min = f1.value || '';
  if (f2.value){
    if (f1.value && f1.value > f2.value){ f1.value = f2.value; }
    f1.max = f2.value;
  } else {
    f1.max = '';
  }
}

function setDefaultAdminRange(days=30, opts={}){
  const f1 = $('#f1'), f2 = $('#f2');
  const start = opts.start || todayYMD();
  const end   = Object.prototype.hasOwnProperty.call(opts, 'end')
    ? opts.end
    : (opts.openEnd ? '' : addDaysYMD(start, days));
  if (f1) f1.value = start;
  if (f2 !== null && f2 !== undefined){
    if (f2) f2.value = end || '';
  }
  if (f1 && !f1.__histDateBound){
    f1.addEventListener('change', syncHistorialDateBounds);
    f1.__histDateBound = true;
  }
  if (f2 && !f2.__histDateBound){
    f2.addEventListener('change', syncHistorialDateBounds);
    f2.__histDateBound = true;
  }
  syncHistorialDateBounds();
}

function drawSalones(arr){
  const el = $('#salones');
  if (!el) return;
  if (!arr.length){
    el.classList.add('is-empty');
    el.innerHTML = '';
    return;
  }
  el.classList.remove('is-empty');
  const rows = arr.map(s=>{
    const meta = parseSalonRestrictionMeta(s.restriccion);
    const parts = [];
    if (meta.intervals && meta.intervals.length){ parts.push(`Horarios: ${meta.intervals.join(', ')}`); }
    if (meta.requiresApproval){ parts.push('Requiere aprobación manual'); }
    const restr = parts.length ? parts.join('<br/>') : '—';
    const conserjeTxt = String(s.requiere_conserje||'SI').toUpperCase()==='SI' ? 'Sí' : 'No';
    const adminTxt = String(s.administracion_id||'1');
    return `<tr>
      <td data-th="ID">${s.id}</td><td data-th="Salón">${s.nombre}</td><td data-th="Capacidad">${s.capacidad}</td>
      <td data-th="Restricción">${restr}</td>
      <td data-th="Conserje">${conserjeTxt}</td>
      <td data-th="Admin">${adminTxt}</td>
      <td data-th="Estado">${s.habilitado?'<span class="tag">Habilitado</span>':'<span class="tag" style="background:#fee2e2;color:#991b1b">Deshabilitado</span>'}</td>
      <td data-th="Acción"><button data-id="${s.id}" data-act="${s.habilitado?'off':'on'}" class="btn-blue">${s.habilitado?'Deshabilitar':'Habilitar'}</button></td>
    </tr>`;
  }).join('');
  el.innerHTML = `<table class="table-center salones-table"><thead><tr><th>ID</th><th>Salón</th><th>Capacidad</th><th>Restricción</th><th>Conserje</th><th>Admin</th><th>Estado</th><th>Acción</th></tr></thead><tbody>${rows}</tbody></table>`;
  el.querySelectorAll('button').forEach(b=> b.onclick = ()=> toggleSalon(b.dataset.id, b.dataset.act==='on'));
}

function populateHistorialSalonFilter(list){
  const sel = document.getElementById('fSalon');
  if (!sel) return;
  const previous = sel.value;
  const options = ['<option value="">[Todos los salones]</option>'];
  (list||[]).forEach(s => {
    options.push(`<option value="${escHtml(s.id)}">${escHtml(s.nombre)}</option>`);
  });
  sel.innerHTML = options.join('');
  if (previous && (list||[]).some(s => String(s.id) === String(previous))){
    sel.value = previous;
  }
}

function updateSolicitanteFilterOptions(items, selected){
  const sel = document.getElementById('fSolicitante');
  if (!sel) return;
  const previous = selected || sel.value || '';
  const options = ['<option value="">[Todos los solicitantes]</option>'];
  (items||[]).forEach(item => {
    options.push(`<option value="${escHtml(item.email)}">${escHtml(item.label)}</option>`);
  });
  sel.innerHTML = options.join('');
  if (previous && (items||[]).some(it => it.email === previous)){
    sel.value = previous;
  } else {
    sel.value = '';
  }
}

function updateConserjeFilterOptions(items, selected){
  const sel = document.getElementById('fConserje');
  if (!sel) return;
  const previous = selected || sel.value || '';
  const options = ['<option value="">[Todos los conserjes]</option>'];
  let hasUnassigned = false;
  (items||[]).forEach(item => {
    if (!item) return;
    if (item.codigo === CON_UNASSIGNED){ hasUnassigned = true; }
    options.push(`<option value="${escHtml(item.codigo)}">${escHtml(item.label)}</option>`);
  });
  sel.innerHTML = options.join('');
  if (previous && (items||[]).some(it => it.codigo === previous)){
    sel.value = previous;
  } else if (previous === CON_UNASSIGNED){
    sel.value = hasUnassigned ? CON_UNASSIGNED : '';
  } else {
    sel.value = '';
  }
}

function updateDynamicFilters(meta, filters){
  const metaObj = meta || {};
  updateSolicitanteFilterOptions(metaObj.solicitantes || [], filters && filters.solicitanteEmail);
  updateConserjeFilterOptions(metaObj.conserjes || [], filters && filters.conserjeCodigo);
}

function resetHistorialFilters(){
  setDefaultAdminRange(30, { openEnd:true });
  const hora1 = document.getElementById('fHora1');
  const hora2 = document.getElementById('fHora2');
  if (hora1) hora1.value = '';
  if (hora2) hora2.value = '';
  const estado = document.getElementById('fEstado');
  if (estado) estado.value = '';
  const solicitante = document.getElementById('fSolicitante');
  if (solicitante) solicitante.value = '';
  const conserje = document.getElementById('fConserje');
  if (conserje) conserje.value = '';
  const texto = document.getElementById('fTexto');
  if (texto) texto.value = '';
  const salon = document.getElementById('fSalon');
  if (salon) salon.value = '';
  syncHistorialDateBounds();
}

function collectHistorialFilters(){
  const f1 = $('#f1'), f2 = $('#f2');
  const hora1 = normalizeHHMM($('#fHora1') ? $('#fHora1').value : '');
  const hora2 = normalizeHHMM($('#fHora2') ? $('#fHora2').value : '');
  if ((hora1 && !hora2) || (!hora1 && hora2)){
    modal('Completa ambos campos de hora para aplicar el filtro.');
    return null;
  }
  if (hora1 && hora2 && hora1 > hora2){
    modal('La hora inicial debe ser menor o igual a la hora final.');
    return null;
  }
  const filters = {
    fechaDesde: f1 && f1.value ? f1.value : '',
    fechaHasta: f2 && f2.value ? f2.value : '',
    horaDesde: hora1 || '',
    horaHasta: hora2 || '',
    salonId: ($('#fSalon') && $('#fSalon').value) || '',
    estado: ($('#fEstado') && $('#fEstado').value) || '',
    solicitanteEmail: ($('#fSolicitante') && $('#fSolicitante').value) || '',
    conserjeCodigo: ($('#fConserje') && $('#fConserje').value) || '',
    texto: ($('#fTexto') && $('#fTexto').value || '').trim()
  };
  if (filters.estado) filters.estado = filters.estado.toUpperCase();
  return filters;
}

function applyPresetFilters(){
  const preset = window.__ADMIN_PRESET__ || {};
  if (__PRESET_APPLIED__){
    syncHistorialDateBounds();
    return;
  }
  if (!preset || typeof preset !== 'object'){
    __PRESET_APPLIED__ = true;
    syncHistorialDateBounds();
    return;
  }
  const assign = (id, value) => {
    if (value === undefined || value === null || value === '') return true;
    const el = document.getElementById(id);
    if (!el){ return false; }
    el.value = value;
    return el.value === value;
  };
  assign('f1', preset.fechaDesde);
  assign('f2', preset.fechaHasta);
  assign('fHora1', preset.horaDesde);
  assign('fHora2', preset.horaHasta);
  assign('fEstado', preset.estado ? String(preset.estado).toUpperCase() : '');
  assign('fTexto', preset.texto);
  const salonOk = !preset.salonId || assign('fSalon', preset.salonId);
  const solicitanteOk = !preset.solicitanteEmail || assign('fSolicitante', preset.solicitanteEmail.toLowerCase());
  const conserjeOk = !preset.conserjeCodigo || assign('fConserje', preset.conserjeCodigo);
  if (!salonOk || !solicitanteOk || !conserjeOk){
    // Intenta de nuevo cuando las opciones estén disponibles
    syncHistorialDateBounds();
    return;
  }
  __PRESET_APPLIED__ = true;
  syncHistorialDateBounds();
}

function exportarReservas(){
  const filters = collectHistorialFilters();
  if (!filters) return;
  Busy.show('Generando reporte…');
  google.script.run
    .withSuccessHandler(r => {
      Busy.hide();
      if (r && r.ok && r.url){
        window.open(r.url, '_blank');
      } else {
        modal((r && r.msg) || 'No se pudo generar el reporte.');
      }
    })
    .withFailureHandler(()=>{ Busy.hide(); modal('No se pudo generar el reporte.'); })
    .apiExportReservasAdmin(filters);
}
function toggleSalon(id, on){ Busy.show('Guardando…'); google.script.run
  .withSuccessHandler(r=>{ Busy.hide(); if(r&&r.ok){ loadSalones(); } else modal(r&&r.msg||'No se pudo actualizar'); })
  .withFailureHandler(e=>{ Busy.hide(); modal('Error al actualizar'); })
  .apiToggleSalon(id, on);
}

function drawReservas(arr){
  const el = $('#reservas');
  if (!arr.length){ el.innerHTML='<p>Sin resultados.</p>'; return; }
  const fmt12 = (hhmm)=>{ if (!/^\d{2}:\d{2}$/.test(hhmm||'')) return hhmm||''; let [h,m]=hhmm.split(':').map(Number); const am=h<12; h=(h%12)||12; return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')} ${am?'a.m.':'p.m.'}`; };
  const fmtDateDMY = (ymd)=>{ const [y,m,d]=(ymd||'').split('-'); return (y&&m&&d)? `${d}/${m}/${y}` : (ymd||''); };
  const now = new Date();
  const tooLate = (r)=>{ // true si no se permite actuar (pasado o <30min)
    try{
      const [hh,mi] = (r.hora_inicio||'00:00').split(':').map(Number);
      const dt = new Date(r.fecha+'T00:00:00'); dt.setHours(hh||0, mi||0, 0, 0);
      return now.getTime() > (dt.getTime() - 30*60*1000);
    }catch(e){ return false; }
  };
  const rows = arr.map(r=>{
    const fecha = fmtDateDMY(r.fecha);
    const hora  = `${fmt12(r.hora_inicio)} - ${fmt12(r.hora_fin)}`;
    const estStr = String(r.estado||'').toUpperCase();
    let estNic = estStr==='APROBADA'?'Aprobada':(estStr==='CANCELADA'?'Cancelada':(estStr==='PENDIENTE'?'Pendiente':r.estado||''));
    let estCls = estStr==='APROBADA'?'pill pill--ok':(estStr==='CANCELADA'?'pill pill--bad':(estStr==='PENDIENTE'?'pill pill--pending':'pill pill--other'));
    const late = tooLate(r);
    const salonNombre = escHtml(r.salon_nombre || '');
    const eventoNombre = escHtml(r.evento_nombre || '');
    const publicoTipo = r.publico_tipo ? escHtml(r.publico_tipo) : '';
    const eventoCell = `<span class="val"><span class="cell-main">${eventoNombre}</span>${publicoTipo ? `<span class="cell-note">Público: ${publicoTipo}</span>` : ''}</span>`;
    const solicitanteNombre = escHtml(r.solicitante_nombre || '');
    const solicitanteEmail = r.solicitante_email ? escHtml(r.solicitante_email) : '';
    const solicitanteExt = r.extension ? escHtml(r.extension) : '';
    const solicitanteMetaParts = [];
    if (solicitanteEmail) solicitanteMetaParts.push(`<span>${solicitanteEmail}</span>`);
    if (solicitanteExt) solicitanteMetaParts.push(`<span>Ext. ${solicitanteExt}</span>`);
    const solicitanteMeta = solicitanteMetaParts.length ? `<span class="cell-meta">${solicitanteMetaParts.join('<span class="cell-sep">•</span>')}</span>` : '';
    const solicitanteCell = `<span class="val"><span class="cell-main">${solicitanteNombre || '—'}</span>${solicitanteMeta}</span>`;
    // Columna Conserje (reglas: no habilitar si cancelada o late)
    let colConserje = '';
    if (r.conserje_requerido==='SI'){
      if (estStr==='CANCELADA' || late){
        // Mostrar nombre si había asignado; si no, vacío
        if (r.conserje_codigo_asignado){
          const code = r.conserje_codigo_asignado;
          const name = (r.conserje_nombre && r.conserje_nombre.trim())
                      || (__CON_MAP__ && __CON_MAP__[code]?.nombre)
                      || code;
          colConserje = `<span>${escHtml(name)}</span>`;
        } else {
          colConserje = '';
        }
      } else {
        if (r.conserje_codigo_asignado){
          const code = r.conserje_codigo_asignado;
          const name = (r.conserje_nombre && r.conserje_nombre.trim())
                      || (__CON_MAP__ && __CON_MAP__[code]?.nombre)
                      || code;
          colConserje = `<a href="#" class="asignar-link" data-id="${r.id}">${escHtml(name)}</a>`;
        } else {
          colConserje = `<a href="#" class="asignar-link" data-id="${r.id}">Asignar</a>`;
        }
      }
    }
    let acciones = '';
    if (estStr==='APROBADA' && !late){
      acciones = `<button class="btn-blue" data-id="${r.id}" data-action="cancel">Cancelar</button>`;
    } else if (estStr==='PENDIENTE'){
      const approveBtn = `<button class="btn-blue" data-id="${r.id}" data-action="approve">Aprobar</button>`;
      const cancelBtn = `<button class="btn-blue btn--sm" data-id="${r.id}" data-action="cancel" data-pending="1">Cancelar</button>`;
      acciones = `<div style="display:flex;flex-direction:column;gap:6px;">${approveBtn}${cancelBtn}</div>`;
    }
    return `
      <tr>
        <td data-th="Fecha"><span class="val">${fecha}</span></td>
        <td data-th="Hora"><span class="val">${hora}</span></td>
        <td data-th="Salón"><span class="val">${salonNombre}</span></td>
        <td data-th="Evento">${eventoCell}</td>
        <td data-th="Solicitante">${solicitanteCell}</td>
      <td data-th="Estado"><span class="${estCls}">${estNic}</span></td>
        <td data-th="Conserje"><span class="val">${colConserje}</span></td>
        <td data-th=""><span class="val">${acciones}</span></td>
      </tr>`;
  }).join('');
  el.innerHTML = `
    <div class="cards-area">
      <table class="resp-table table-center">
        <thead>
          <tr>
            <th>Fecha</th><th>Hora</th><th>Salón</th><th>Evento</th><th>Solicitante</th><th>Estado</th><th>Conserje</th><th></th>
          </tr>
        </thead>
        <tbody>${rows}</tbody>
      </table>
    </div>`;

  // handlers
  el.querySelectorAll('button[data-action]').forEach(btn=>{
    const act = btn.dataset.action;
    if (act === 'cancel'){
      btn.onclick = ()=> cancelarAdmin(btn.dataset.id, btn.dataset.pending ? 'Cancelada por administración (pendiente)' : undefined);
    } else if (act === 'approve'){
      btn.onclick = ()=> aprobarAdmin(btn.dataset.id);
    }
  });
  el.querySelectorAll('a.asignar-link').forEach(a=> a.onclick = (e)=>{ e.preventDefault(); openAsignarModal(a.dataset.id); });
}

function cancelarAdmin(id, defaultMotivo){
  const motivo = prompt('Motivo de cancelación:', defaultMotivo || 'Cancelada por administración'); if (motivo===null) return;
  Busy.show('Cancelando…'); google.script.run
    .withSuccessHandler(r=>{ Busy.hide(); if(r&&r.ok){ buscar(); } else modal(r&&r.msg||'No se pudo cancelar'); })
    .withFailureHandler(e=>{ Busy.hide(); modal('Error al cancelar'); })
    .apiCancelarReservaAdmin(id, motivo);
}

function aprobarAdmin(id){
  Busy.show('Aprobando…');
  google.script.run
    .withSuccessHandler(r=>{
      Busy.hide();
      if (r && r.ok){
        modal(r.already ? 'La reserva ya estaba aprobada.' : 'Reserva aprobada.');
        buscar();
      } else {
        modal((r && r.msg) || 'No se pudo aprobar la reserva.');
      }
    })
    .withFailureHandler(()=>{ Busy.hide(); modal('Error al aprobar la reserva.'); })
    .apiAprobarReservaAdmin(id);
}

function buildSalonCaches(all){
  window.__SALON_CAPS__ = {};
  window.__SALON_META_ADMIN__ = {};
  __SALON_CFG_MAP__ = {};
  (all||[]).forEach(s => {
    window.__SALON_CAPS__[s.id] = Number(s.capacidad)||0;
    window.__SALON_META_ADMIN__[s.id] = parseSalonRestrictionMeta(s.restriccion);
    __SALON_CFG_MAP__[s.id] = {
      duracion_min: Number(s.duracion_min||30),
      duracion_max: Number(s.duracion_max||240),
      duracion_step: Number(s.duracion_step||30),
      horario_inicio: s.horario_inicio,
      horario_fin: s.horario_fin
    };
  });
}

function populateSalonSelect(all){
  const sel = document.getElementById('a-salon');
  if (!sel) return;
  const opts = ['<option value="">[Seleccionar]</option>']
    .concat((all||[]).map(s => `<option value="${s.id}" ${s.habilitado ? '' : 'disabled'}>${s.nombre}${s.habilitado?'':' (Deshabilitado)'}</option>`));
  sel.innerHTML = opts.join('');
  if (!sel.__metaListenerAttached){
    sel.addEventListener('change', applyAdminSalonMetaHints);
    sel.__metaListenerAttached = true;
  }
  applyAdminSalonMetaHints();
}

function loadSalones(){
  google.script.run
    .withSuccessHandler(r=>{
      const payload = (r&&r.data) || {};
      const manage = Array.isArray(payload.manage) ? payload.manage : [];
      const all    = Array.isArray(payload.all) ? payload.all : manage.slice();
      __SALONES_MANAGE__ = manage;
      __SALONES_ALL__ = all;
      drawSalones(manage);
      buildSalonCaches(all);
      populateSalonSelect(all);
      populateHistorialSalonFilter(all);
      applyPresetFilters();
      initSalonCapacityAdmin(all);
      renderDurationsFromConfigAdmin();
      // limpia el tag de cap máx al cargar
      const tag = document.getElementById('a-capMaxTag');
      if (tag) tag.textContent = '';
    })
    .withFailureHandler(()=> modal('No se pudo cargar salones'))
    .apiListSalonesAdmin();
}

function buscar(){
  const filters = collectHistorialFilters();
  if (!filters) return;
  Busy.show('Buscando…');
  __LAST_HIST_FILTERS__ = { ...filters };
  google.script.run
    .withSuccessHandler(r=>{
      Busy.hide();
      const data = (r && r.data) || [];
      drawReservas(data);
      updateDynamicFilters((r && r.meta) || {}, filters);
    })
    .withFailureHandler(()=>{ Busy.hide(); modal('No se pudo cargar reservas'); })
    .apiListReservasAdmin(filters);
}

function init(){
  Busy.reset();
  try{
    $('#logo').src = (window.__LOGO_URL__ || '');
  }catch(e){/* noop */}

  resetHistorialFilters();
  loadSalones();
  loadConserjeMap(()=> {
    applyPresetFilters();
    const waitAndSearch = ()=>{
      if (__PRESET_APPLIED__){
        buscar();
      } else {
        setTimeout(waitAndSearch, 120);
      }
    };
    waitAndSearch();
  });
  $('#btnBuscar').onclick = buscar;
  const btnReset = document.getElementById('btnReset');
  if (btnReset) btnReset.onclick = ()=>{ resetHistorialFilters(); buscar(); };
  const btnExport = document.getElementById('btnExport');
  if (btnExport) btnExport.onclick = exportarReservas;
  if (IS_GENERAL_ADMIN){
    const btnCon = document.getElementById('btnConserjes');
    if (btnCon) btnCon.onclick = openConserjesModal;
    const btnUsr = document.getElementById('btnUsuarios');
    if (btnUsr) btnUsr.onclick = openUsuariosModal;
  } else {
    const btnCon = document.getElementById('btnConserjes');
    if (btnCon) btnCon.style.display = 'none';
    const btnUsr = document.getElementById('btnUsuarios');
    if (btnUsr) btnUsr.style.display = 'none';
  }

  // === Listeners de validación de capacidad en el formulario Admin ===
  const aSalon = document.getElementById('a-salon');
  const aCant  = document.getElementById('a-cant');
  if (aSalon){
    aSalon.addEventListener('change', ()=>{
      // actualiza tag y revalida
      const cap = (window.__SALON_CAPS__||{})[aSalon.value||''] || 0;
      const tag = document.getElementById('a-capMaxTag');
      if (tag) tag.textContent = cap ? `(máx ${cap})` : '';
      if (aCant){
        const n = Number(aCant.value||0);
        const bad = cap && n>cap;
        let capErr = document.getElementById('a-cantError');
        if (!capErr){
          capErr = document.createElement('small');
          capErr.id = 'a-cantError';
          capErr.className = 'error';
          aCant.insertAdjacentElement ? aCant.insertAdjacentElement('afterend', capErr) : aCant.parentNode.appendChild(capErr);
        }
        capErr.hidden = !bad;
        capErr.textContent = bad ? `La cantidad ingresada excede la capacidad máxima (${cap}).` : '';
        aCant.classList.toggle('input-error', bad);
      }
    });
  }
  if (aCant){
    aCant.addEventListener('input', ()=>{
      const cap = (window.__SALON_CAPS__||{})[(aSalon&&aSalon.value)||''] || 0;
      const n = Number(aCant.value||0);
      const bad = cap && n>cap;
      let capErr = document.getElementById('a-cantError');
      if (!capErr){
        capErr = document.createElement('small');
        capErr.id = 'a-cantError';
        capErr.className = 'error';
        aCant.insertAdjacentElement ? aCant.insertAdjacentElement('afterend', capErr) : aCant.parentNode.appendChild(capErr);
      }
      capErr.hidden = !bad;
      capErr.textContent = bad ? `La cantidad ingresada excede la capacidad máxima (${cap}).` : '';
      aCant.classList.toggle('input-error', bad);
    });
  }

  // ===== Crear reserva (Admin) =====
  bootCreateAdmin();
}

// ===== Crear reserva (Admin) =====
function bootCreateAdmin(){
  __HOST_FORM_ADMIN__ = createHostFormController({
    toggleYes: document.getElementById('a-hostYes'),
    toggleNo: document.getElementById('a-hostNo'),
    fields: {
      nombre: document.getElementById('a-nombre'),
      email:  document.getElementById('a-email'),
      dep:    document.getElementById('a-dep'),
      ext:    document.getElementById('a-ext')
    },
    errorHints: {
      email: document.getElementById('a-emailError'),
      ext:   document.getElementById('a-extError')
    },
    listEl: document.getElementById('a-hostSuggestions'),
    me: window.__ME__ || {}
  });

  // Dominio email en Admin
  (function(){
    const email = document.getElementById('a-email');
    const hint  = document.getElementById('a-emailError');
    const okDom = (v)=> /@infotep\.gob\.do$/i.test(String(v||'').trim());
    if (!email || !hint) return;
    email.addEventListener('blur', ()=>{
      const v = email.value;
      hint.hidden = !v || okDom(v);
    });
  })();

  // Prepara fecha mínima = hoy
  const today = new Date(); const y=today.getFullYear(), m=String(today.getMonth()+1).padStart(2,'0'), d=String(today.getDate()).padStart(2,'0');
  const ymd = `${y}-${m}-${d}`;
  const $f = $('#a-fecha'); if ($f){ $f.min = ymd; $f.value = ymd; }
  // Cargar salones
  const selSalon = $('#a-salon');
  if (selSalon){
    selSalon.innerHTML = '<option value="">[Seleccionar]</option>';
  }
  // Duraciones desde config (serán inyectadas por servidor en Public; aquí replicamos)
  renderDurationsFromConfigAdmin();
  // Eventos
  $('#a-salon').onchange = scheduleRefreshSlotsAdmin;
  $('#a-fecha').onchange = scheduleRefreshSlotsAdmin;
  $('#a-dur').onchange   = scheduleRefreshSlotsAdmin;
  $('#a-hora').onchange  = verifySelectedSlotAdmin;
  $('#a-crear').onclick  = crearReservaAdmin;

  const refreshBtn = document.getElementById('a-refreshSlots');
  if (refreshBtn){
    refreshBtn.addEventListener('click', ()=>{
      refreshSlotsAdmin();
    });
  }
  const resetBtn = document.getElementById('a-resetForm');
  if (resetBtn){
    resetBtn.addEventListener('click', ()=>{
      resetAdminReservaForm();
    });
  }

  // Filtro de extensión (solo números) con hint
  const ext = $('#a-ext'), extErr = $('#a-extError');
  if (ext){
    ext.addEventListener('input', (e)=>{
      const before = e.target.value;
      const after  = before.replace(/\D+/g,'');
      const bad    = before !== after;
      if (bad) e.target.value = after;
      if (extErr){
        extErr.hidden = !(bad && before.length>0);
        e.target.classList.toggle('input-error', bad);
      }
    });
  }
  // Capacidad: título dinámico y hint al exceder (sin pedir al server)
  initSalonCapacityAdmin();
  resetAdminReservaForm();
}

function resetAdminReservaForm(){
  const salonSel = $('#a-salon'); if (salonSel) salonSel.value = '';
  renderDurationsFromConfigAdmin();
  const fechaEl = $('#a-fecha'); if (fechaEl) fechaEl.value = todayYMD();
  const durEl = $('#a-dur'); if (durEl) durEl.value = (durEl.querySelector('option')?.value || '');
  const horaEl = $('#a-hora'); if (horaEl) horaEl.innerHTML = '<option value="">[Seleccionar]</option>';
  const restrHint = document.getElementById('a-restriccionHint'); if (restrHint){ restrHint.hidden = true; restrHint.textContent = ''; }
  const apprHint = document.getElementById('a-aprobacionHint'); if (apprHint){ apprHint.hidden = true; apprHint.textContent = ''; }
  if (__HOST_FORM_ADMIN__){
    __HOST_FORM_ADMIN__.reset();
  } else {
    const nombre = $('#a-nombre'); if (nombre) nombre.value = '';
    const email = $('#a-email'); if (email) email.value = '';
    const dep = $('#a-dep'); if (dep) dep.value = '';
    const ext = $('#a-ext'); if (ext) ext.value = '';
  }
  const emailErr = $('#a-emailError'); if (emailErr) emailErr.hidden = true;
  const extErr = $('#a-extError'); if (extErr) extErr.hidden = true;
  const evento = $('#a-evento'); if (evento) evento.value = '';
  const cant = $('#a-cant'); if (cant){ cant.value = ''; cant.classList.remove('input-error'); }
  const cantErr = $('#a-cantError'); if (cantErr){ cantErr.hidden = true; cantErr.textContent = ''; }
  const publico = $('#a-publico'); if (publico) publico.value = '';
  applyAdminSalonMetaHints();
  scheduleRefreshSlotsAdmin();
}

let _admReqSeq = 0;
function scheduleRefreshSlotsAdmin(){ clearTimeout(window.__admDeb__); window.__admDeb__=setTimeout(refreshSlotsAdmin, 200); }

function refreshSlotsAdmin(){
  const salon = $('#a-salon').value||'';
  const fecha = $('#a-fecha').value||'';
  const dur   = Number($('#a-dur').value||0);
  const prio = getEffectivePriorityForSalonAdmin(salon);
  if(!salon||!fecha||!dur){
    $('#a-hora').innerHTML='';
    __SLOT_INFO_ADMIN__ = {};
    if (typeof window !== 'undefined'){ window.__SLOT_INFO_ADMIN__ = __SLOT_INFO_ADMIN__; }
    // limpia meta y hint si no hay salón/fecha/duración
    const tag = document.getElementById('a-capMaxTag');
    if (tag) tag.textContent = '';
    const capErr = document.getElementById('a-cantError');
    if (capErr){ capErr.hidden = true; capErr.textContent=''; }
    $('#a-cant')?.classList.remove('input-error');
    applyAdminSalonMetaHints();
    return;
  }

  const my = ++_admReqSeq;
  Busy.show('Verificando disponibilidad…');

  google.script.run
    .withSuccessHandler(r=>{
      if (my!==_admReqSeq) return;
      Busy.hide();

      let arr = Array.isArray(r && r.data) ? r.data : [];

      const cfgSalon = (__SALON_CFG_MAP__||{})[salon];
      if (cfgSalon){
        const cfgIni = hhmmToMinutes(cfgSalon.horario_inicio);
        const cfgFin = hhmmToMinutes(cfgSalon.horario_fin);
        if (!isNaN(cfgIni) && !isNaN(cfgFin) && cfgFin > cfgIni){
          arr = arr.filter(s => {
            const iniMin = hhmmToMinutes(s.inicio);
            const finMin = hhmmToMinutes(s.fin);
            if (isNaN(iniMin) || isNaN(finMin)) return true;
            return iniMin >= cfgIni && finMin <= cfgFin;
          });
        }
      }

      __SLOT_INFO_ADMIN__ = {};
      arr.forEach(s => { __SLOT_INFO_ADMIN__[s.inicio] = s; });
      if (typeof window !== 'undefined'){ window.__SLOT_INFO_ADMIN__ = __SLOT_INFO_ADMIN__; }

      // --- Filtrar horas pasadas cuando la fecha es hoy ---
      const todayYMD = (()=>{
        const d = new Date();
        const y = d.getFullYear();
        const m = String(d.getMonth()+1).padStart(2,'0');
        const dd= String(d.getDate()).padStart(2,'0');
        return `${y}-${m}-${dd}`;
      })();
      const isToday = fecha === todayYMD;
      const now     = new Date();
      const nowMin  = now.getHours()*60 + now.getMinutes();
      const toMin   = (hhmm)=>{ const [h,m] = String(hhmm||'').split(':').map(Number); return (h*60)+(m||0); };

      const filtered = arr.filter(s => !isToday || toMin(s.inicio) > nowMin);

      const first = '<option value="">[Seleccionar]</option>';
      const opts = filtered.map(s=>{
        const ocupado = !s.disponible;
        const otraAdmin = !!s.otraAdministracion;
        const rawMax = (s.maxPrio==null || s.maxPrio==='') ? null : Number(s.maxPrio);
        const maxP = (Number.isFinite ? Number.isFinite(rawMax) : isFinite(rawMax)) ? rawMax : null;
        const puede = !!s.seleccionable;
        const userLowerThanMax = maxP !== null && prio < maxP;
        const motivo = String(s.motivoConciliacion || '').toUpperCase();
        let note = '';
        const esRestriccion = !!s.restringido || String(s.motivoRestriccion||'').toUpperCase()==='RESTRICCION';
        if (ocupado){
          if (!puede){
            if (motivo === 'PUBLICO_EXTERNO'){
              note = userLowerThanMax ? ' (reservado)' : ' (evento externo – coordinar)';
            } else if (motivo === 'MISMA_PRIORIDAD' && prio > 0){
              note = ' (reservado – coordinar)';
            } else if (userLowerThanMax || prio > 0 || maxP!=null) {
              note = ' (reservado)';
            }
          } else {
            note = ' (ocupado – puedes reasignar)';
          }
        }
        if (otraAdmin){
          note = ' (reservado – coordinar otra administración)';
        }
        if (esRestriccion){
          note = ' (horario restringido)';
        }
        const label = `${s.inicio} - ${s.fin}${note}`;
        const disableOption = esRestriccion || (!puede && (userLowerThanMax || prio <= 0));
        const disabledAttr = disableOption ? 'disabled' : '';
        return `<option value="${s.inicio}" ${disabledAttr}>${label}</option>`;
      }).join('');

      $('#a-hora').innerHTML = first + opts;
      $('#a-hora').value = '';
      applyAdminSalonMetaHints();

      // === Actualizar el tag "(máx N)" en el label
      const tag = document.getElementById('a-capMaxTag');
      if (tag){
        const cap = (window.__SALON_CAPS__||{})[salon] || 0;
        tag.textContent = cap ? `(máx ${cap})` : '';
      }
      // Revalida cantidad actual contra la nueva capacidad
      const cantEl = document.getElementById('a-cant');
      if (cantEl){
        const cap = (window.__SALON_CAPS__||{})[salon] || 0;
        const n = Number(cantEl.value||0);
        const bad = cap && n>cap;
        let capErr = document.getElementById('a-cantError');
        if (!capErr){
          capErr = document.createElement('small');
          capErr.id = 'a-cantError';
          capErr.className = 'error';
          cantEl.insertAdjacentElement ? cantEl.insertAdjacentElement('afterend', capErr) : cantEl.parentNode.appendChild(capErr);
        }
        capErr.hidden = !bad;
        capErr.textContent = bad ? `La cantidad ingresada excede la capacidad máxima (${cap}).` : '';
        cantEl.classList.toggle('input-error', bad);
      }
    })
    .withFailureHandler(()=>{ Busy.hide(); modal('No se pudo obtener disponibilidad'); })
    .apiListDisponibilidad(fecha, salon, dur, getEffectivePriorityForSalonAdmin(salon));
}

function verifySelectedSlotAdmin(){
  const salon=$('#a-salon').value||''; const fecha=$('#a-fecha').value||''; const dur=Number($('#a-dur').value||0); const ini=$('#a-hora').value||'';
  if(!salon||!fecha||!dur||!ini) return;
  const slotInfo = (__SLOT_INFO_ADMIN__||{})[ini];
  if (showBlockedSlotMessageAdmin(slotInfo)){
    $('#a-hora').value='';
    return;
  }
  if (getEffectivePriorityForSalonAdmin(salon) > 0) return;
  Busy.show('Confirmando intervalo…');
  google.script.run
    .withSuccessHandler(r=>{
      Busy.hide();
      if(!r||!r.ok) return;
      if(!r.disponible){
        const motivo = String(r.motivo||'').toUpperCase();
        if (motivo === 'RESTRICCION'){
          modal('Este salón no permite reservas en el horario seleccionado. Elige otro intervalo.');
        } else if (motivo === 'ADMIN_OTRO'){
          modal('Este horario pertenece a otra administración. Coordina con el equipo responsable antes de reagendar.');
        } else {
          modal('Ese intervalo ya no está disponible.');
        }
        const sel = $('#a-hora');
        const opt = sel && sel.querySelector ? sel.querySelector(`option[value="${ini}"]`) : null;
        if (opt) opt.disabled = true;
        $('#a-hora').value='';
        scheduleRefreshSlotsAdmin();
      }
    })
    .withFailureHandler(()=>{ Busy.hide(); })
    .apiCheckSlot(fecha, salon, ini, dur, getEffectivePriorityForSalonAdmin(salon));
}
function crearReservaAdmin(){
  const p = {
    salon_id: $('#a-salon').value,
    fecha: $('#a-fecha').value,
    hora_inicio: $('#a-hora').value,
    duracion_min: Number($('#a-dur').value||0),
    nombre: $('#a-nombre').value.trim(),
    email: ($('#a-email').value||'').trim(),
    departamento: $('#a-dep').value.trim(),
    extension: $('#a-ext').value.trim(),
    cant_personas: $('#a-cant').value,
    evento_nombre: $('#a-evento').value.trim(),
    publico_tipo: $('#a-publico').value
  };
  if (__HOST_FORM_ADMIN__){
    p.host_es_sesion = __HOST_FORM_ADMIN__.isSessionHost();
    const selected = __HOST_FORM_ADMIN__.selectedHost && __HOST_FORM_ADMIN__.selectedHost();
    if (!p.host_es_sesion && selected && selected.email){
      p.host_lookup_email = selected.email;
    }
  } else {
    p.host_es_sesion = true;
  }
  if (!p.salon_id || !p.fecha || !p.hora_inicio || !p.duracion_min || !p.nombre || !p.email || !p.departamento || !p.extension || !p.cant_personas || !p.evento_nombre){
    return modal('Completa todos los campos obligatorios.');
  }
  if (!/@infotep\.gob\.do$/i.test(p.email||'')){
    const hint = document.getElementById('a-emailError'); if (hint) hint.hidden = false;
    return modal('El correo del anfitrión debe ser del dominio @infotep.gob.do');
  }
  const slotInfo = (__SLOT_INFO_ADMIN__||{})[p.hora_inicio];
  if (showBlockedSlotMessageAdmin(slotInfo)){
    $('#a-hora').value='';
    return;
  }
  const prioSalon = getEffectivePriorityForSalonAdmin(p.salon_id);
  if (prioSalon <= 0){
    Busy.show('Verificando disponibilidad…');
    google.script.run
      .withSuccessHandler(r=>{
        Busy.hide();
        if (!r || r.ok !== true){
          return modal('No se pudo confirmar la disponibilidad.');
        }
        if (!r.disponible){
          const motivo = String(r.motivo||'').toUpperCase();
          if (motivo === 'ADMIN_OTRO'){
            modal('Este horario pertenece a otra administración. Coordina con el equipo responsable para liberarlo.');
          } else {
            modal('Ese intervalo ya está reservado. Por favor elige otro.');
          }
          const sel = $('#a-hora');
          const opt = sel && sel.querySelector ? sel.querySelector(`option[value="${p.hora_inicio}"]`) : null;
          if (opt) opt.disabled = true;
          sel.value = '';
          scheduleRefreshSlotsAdmin();
          return;
        }
        crearReservaAdminSubmit(p);
      })
      .withFailureHandler(()=>{ Busy.hide(); modal('No se pudo confirmar la disponibilidad.'); });
    return;
  }
  crearReservaAdminSubmit(p);
}

function crearReservaAdminSubmit(payload){
  Busy.show('Creando reserva…');
  google.script.run
    .withSuccessHandler(r=>{ Busy.hide(); if(r&&r.ok){
      const estado = String(r.estado||'').toUpperCase();
      if (estado === 'PENDIENTE' || r.requiere_aprobacion){
        modal('Solicitud registrada como pendiente. Revisa el historial para aprobarla cuando corresponda.');
      } else {
        modal('Reserva creada.');
      }
      buscar(); // refresca listado
      resetAdminReservaForm();
    } else { modal((r&&r.msg)||'No se pudo crear'); } })
    .withFailureHandler(()=>{ Busy.hide(); modal('Error al crear'); })
    .apiCrearReserva(payload);
}
function getDurationConfigForSalonAdmin(salonId){
  const cfg = (__SALON_CFG_MAP__||{})[salonId];
  if (!cfg) return { ...DEFAULT_DUR_CFG };
  return {
    min: Number(cfg.duracion_min || DEFAULT_DUR_CFG.min),
    max: Number(cfg.duracion_max || DEFAULT_DUR_CFG.max),
    step: Number(cfg.duracion_step || DEFAULT_DUR_CFG.step)
  };
}

function renderDurationsFromConfigAdmin(){
  const sel = $('#a-dur');
  if (!sel) return;
  const salonId = ($('#a-salon') && $('#a-salon').value) || '';
  const cfg = getDurationConfigForSalonAdmin(salonId);
  const prevValue = sel.value || '';
  const min = Math.max(1, Number(cfg.min || DEFAULT_DUR_CFG.min));
  const max = Math.max(min, Number(cfg.max || min));
  const step = Math.max(1, Number(cfg.step || DEFAULT_DUR_CFG.step));
  const opts = ['<option value="">[Seleccionar]</option>'];
  for (let d=min; d<=max; d+=step){
    const label = (d<60)? `${d} minutos` : (d%60===0? `${d/60} ${d===60?'hora':'horas'}` : `${Math.floor(d/60)} horas ${d%60} min`);
    opts.push(`<option value="${d}">${label}</option>`);
  }
  sel.innerHTML = opts.join('');
  if (prevValue && Array.from(sel.options || []).some(opt => opt.value === prevValue)){
    sel.value = prevValue;
  } else {
    sel.value = '';
  }
}

function showBlockedSlotMessageAdmin(slotInfo){
  if (!slotInfo) return false;

  if (slotInfo.restringido || String(slotInfo.motivoRestriccion||'').toUpperCase()==='RESTRICCION'){
    modal('Este horario está restringido para este salón. Selecciona otro intervalo.');
    return true;
  }

  const currentSalonEl = $('#a-salon');
  const currentSalonId = currentSalonEl ? (currentSalonEl.value || '') : '';
  const userPrio = getEffectivePriorityForSalonAdmin(currentSalonId);
  const ocupantes = Array.isArray(slotInfo.ocupantes) ? slotInfo.ocupantes : [];
  const motivo = String(slotInfo.motivoConciliacion || '').toUpperCase();
  const hayEventoExterno = (motivo === 'PUBLICO_EXTERNO') || ocupantes.some(o => isPublicoExternoOMixto(o.publico_tipo));
  const hayMismaPrioridad = (motivo === 'MISMA_PRIORIDAD') || ocupantes.some(o => Number(o.prioridad || 0) === userPrio);
  const rawMaxPrio = (slotInfo.maxPrio == null || slotInfo.maxPrio === '') ? null : Number(slotInfo.maxPrio);
  const maxPrio = (Number.isFinite ? Number.isFinite(rawMaxPrio) : isFinite(rawMaxPrio)) ? rawMaxPrio : null;
  const usuarioTieneMenorPrioridad = maxPrio !== null && userPrio < maxPrio;
  const hayOtraAdmin = ocupantes.some(o => normalizeAdminIdClient(o.administracion_id) !== ADMIN_SCOPE);

  if (!hayEventoExterno && !hayMismaPrioridad && !hayOtraAdmin) {
    return false;
  }
  if (usuarioTieneMenorPrioridad && !hayMismaPrioridad && !hayOtraAdmin) {
    return false;
  }

  const items = ocupantes.map(o => {
    const nombre = escHtml(o.nombre || o.email || 'Reservante');
    const correoHtml = o.email
      ? `<a href="mailto:${escHtml(o.email)}">${escHtml(o.email)}</a>`
      : 'Sin correo disponible';
    const metaPieces = [`Correo: ${correoHtml}`];
    if (o.extension){
      metaPieces.push(`Extensión: ${escHtml(o.extension)}`);
    }
    const meta = `<div class="muted">${metaPieces.join(' · ')}</div>`;
    const horario = `<div class="muted">Horario: ${escHtml(o.inicio || '')} - ${escHtml(o.fin || '')}</div>`;
    const prioridad = `<div class="muted">Prioridad: ${escHtml(String(o.prioridad || 0))}</div>`;
    const evento = o.evento ? `<div class="muted">Evento: ${escHtml(o.evento)}</div>` : '';
    const publico = o.publico_tipo ? `<div class="muted">Tipo de público: ${escHtml(o.publico_tipo)}</div>` : '';
    return `<li><strong>${nombre}</strong>${meta}${horario}${prioridad}${evento}${publico}</li>`;
  }).join('');

  const listaHtml = items ? `<ul style="padding-left:18px;margin:8px 0;">${items}</ul>` : '';

  if (hayEventoExterno){
    const html = `
      <p>Este horario ya está reservado para un evento con público externo o mixto.</p>
      ${listaHtml}
      <p>Debes coordinar con la(s) persona(s) anfitriona(s) para que cancelen la reserva antes de agendar este horario.</p>
    `;
    modal(html, 'Horario reservado', { html: true });
    return true;
  }

  if (hayOtraAdmin){
    const html = `
      <p>Este horario pertenece a otra administración.</p>
      ${listaHtml}
      <p>Debes coordinar con el equipo responsable para que liberen el espacio antes de continuar.</p>
    `;
    modal(html, 'Horario reservado', { html: true });
    return true;
  }

  if (userPrio <= 0) return false;

  const html = `
    <p>Este horario ya está reservado por otra persona con la misma prioridad.</p>
    ${listaHtml}
    <p>Debes coordinar con la otra parte para que cancele su reserva y puedas agendar este horario.</p>
  `;
  modal(html, 'Horario reservado', { html: true });
  return true;
}

// ===== Capacidad (Admin) =====
let __SALON_MAP_ADMIN__ = {}; // { id: {capacidad, nombre} }
let __CAP_LISTENER_BOUND__ = false;
function initSalonCapacityAdmin(all){
  const dataset = Array.isArray(all) ? all : (__SALONES_ALL__ || []);
  __SALON_MAP_ADMIN__ = {};
  (dataset||[]).forEach(s=>{ __SALON_MAP_ADMIN__[s.id] = { cap: Number(s.capacidad||0), nombre: s.nombre }; });
  syncCapLabelAdmin();
  hookCantValidationAdmin();
  const salonSel = document.getElementById('a-salon');
  if (salonSel && !__CAP_LISTENER_BOUND__){
    salonSel.addEventListener('change', ()=>{
      syncCapLabelAdmin();
      renderDurationsFromConfigAdmin();
    });
    __CAP_LISTENER_BOUND__ = true;
  }

  const err = document.getElementById('a-cantError');
  if (err) err.hidden = true;
}
function maxCapForSalonAdmin(){
  const id = $('#a-salon').value||'';
  const rec = __SALON_MAP_ADMIN__[id];
  return rec && rec.cap ? Number(rec.cap) : 0;
}
function syncCapLabelAdmin(){
  const cap = maxCapForSalonAdmin();
  const lab = $('#a-cantLabel');
  if (!lab) return;
  if (cap>0) lab.textContent = `Cant. de personas (máx ${cap})`;
  else lab.textContent = 'Cant. de personas';
}
function hookCantValidationAdmin(){
  const cant = $('#a-cant'), err = $('#a-cantError');
  if (!cant || !err) return;
  // Al cargar, asegúrate de ocultar el hint
  err.hidden = true;
  const check = ()=>{
    const cap = maxCapForSalonAdmin();
    const val = Number(cant.value||0);
    if (!cant.value){ err.hidden = true; return; } // vacío → sin hint
    if (cap>0 && val>cap){
      err.textContent = `Excede la capacidad del salón (máx ${cap}).`;
      err.hidden = false;
    } else {
      err.hidden = true;
    }
  };
  cant.addEventListener('input', check);
  $('#a-salon').addEventListener('change', check);
  // También: si cambias de salón, resetea valor y label si quieres (opcional)
  // $('#a-cant').value = '';
}

// ===== Usuarios (modal) =====
function openUsuariosModal(){
  if (!IS_GENERAL_ADMIN) return;
  const modal = document.getElementById('modalUsers');
  const listEl = document.getElementById('users-list');
  const prioHidden = document.getElementById('u-prio-salones');
  const prioListEl = document.getElementById('u-prio-salones-list');
  const prioPicker = document.getElementById('u-prio-salones-picker');
  const prioAddBtn = document.getElementById('u-prio-salones-add');
  let selected = null; // objeto usuario seleccionado
  const salonDataset = Array.isArray(__SALONES_ALL__) && __SALONES_ALL__.length
    ? __SALONES_ALL__
    : (Array.isArray(__SALONES_MANAGE__) ? __SALONES_MANAGE__ : []);
  const salonMap = {};
  salonDataset.forEach(s => {
    const id = String(s && s.id || '').trim();
    if (!id) return;
    salonMap[id.toUpperCase()] = { id, nombre: s.nombre || id };
  });

  const getPriorityCodes = ()=>{
    if (!prioHidden) return [];
    const raw = String(prioHidden.value || '').trim();
    if (!raw) return [];
    return raw.split(';')
      .map(code => String(code || '').trim().toUpperCase())
      .filter((code, idx, arr) => code && arr.indexOf(code) === idx);
  };
  const syncPriorityCodes = codes => {
    const norm = Array.isArray(codes) ? codes.map(c => String(c || '').trim().toUpperCase()).filter(Boolean) : [];
    const unique = [];
    const seen = {};
    norm.forEach(code => {
      if (!seen[code]){
        seen[code] = true;
        unique.push(code);
      }
    });
    if (prioHidden){
      prioHidden.value = unique.join(';');
    }
    if (prioListEl){
      if (!unique.length){
        prioListEl.innerHTML = '';
        prioListEl.dataset.empty = 'true';
      } else {
        prioListEl.dataset.empty = 'false';
        prioListEl.innerHTML = unique.map(code => {
          const salon = salonMap[code] || {};
          const label = escHtml(`${salon.nombre || code} (${code})`);
          return `<span class="chip" data-code="${code}">${label}<button class="chip-remove" type="button" data-remove-code="${code}" aria-label="Quitar ${label}">×</button></span>`;
        }).join('');
      }
    }
  };
  const populatePriorityPicker = ()=>{
    if (!prioPicker) return;
    const opts = ['<option value="">[Seleccionar salón]</option>'];
    const dataset = salonDataset.slice().sort((a,b)=>{
      const an = String(a && a.nombre || '').toLocaleLowerCase('es');
      const bn = String(b && b.nombre || '').toLocaleLowerCase('es');
      if (an === bn) return String(a && a.id || '').localeCompare(String(b && b.id || ''));
      return an.localeCompare(bn);
    });
    dataset.forEach(s => {
      const id = String(s && s.id || '').trim();
      if (!id) return;
      const name = s && s.nombre ? s.nombre : id;
      opts.push(`<option value="${id}">${escHtml(name)} (${escHtml(id)})</option>`);
    });
    prioPicker.innerHTML = opts.join('');
  };
  const addPrioritySalon = code => {
    const list = getPriorityCodes();
    list.push(String(code || '').trim().toUpperCase());
    syncPriorityCodes(list);
  };
  const removePrioritySalon = code => {
    const target = String(code || '').trim().toUpperCase();
    const list = getPriorityCodes().filter(item => item !== target);
    syncPriorityCodes(list);
  };

  populatePriorityPicker();
  syncPriorityCodes(getPriorityCodes());
  if (prioAddBtn && prioPicker){
    prioAddBtn.onclick = ()=>{
      const code = String(prioPicker.value || '').trim();
      if (!code) return;
      addPrioritySalon(code);
      prioPicker.value = '';
      prioPicker.focus();
    };
    prioPicker.addEventListener('change', ()=>{
      const code = String(prioPicker.value || '').trim();
      if (!code) return;
      addPrioritySalon(code);
      prioPicker.value = '';
    });
  }
  if (prioListEl){
    prioListEl.addEventListener('click', ev => {
      const btn = ev.target.closest('[data-remove-code]');
      if (!btn) return;
      removePrioritySalon(btn.getAttribute('data-remove-code'));
    });
  }
  const draw = (items=[])=>{
    if (!listEl) return;
    if (!items.length){
      listEl.classList.add('is-empty');
      listEl.innerHTML = '';
      selected = null;
      clearUserForm();
      return;
    }
    const rows = items.map(u=>`
      <tr class="u-row" data-email="${u.email}">
        <td data-th="Nombre / Correo">${u.nombre||'(sin nombre)'}<div class="muted" style="font-size:12px">${u.email}</div></td>
        <td data-th="Departamento">${u.departamento||''}</td>
        <td data-th="Rol"><span class="tag">${u.rol||''}</span></td>
        <td data-th="Prioridad">${Number(u.prioridad||0)}</td>
        <td data-th="Salones con prioridad">${u.prioridad_salones||''}</td>
        <td data-th="Estado">${u.estado||''}</td>
        <td data-th="Ext.">${u.extension||''}</td>
        <td data-th="Admin">${u.administracion_id||'1'}</td>
      </tr>
    `).join('');
    const cards = items.map(u=>{
      const email = escHtml(u.email||'');
      const name = escHtml(u.nombre||'(sin nombre)');
      const departamento = escHtml(u.departamento||'');
      const rol = escHtml(u.rol||'');
      const prioridad = Number(u.prioridad||0);
      const prioridadSalones = escHtml(u.prioridad_salones||'');
      const estado = escHtml(u.estado||'');
      const extension = escHtml(u.extension||'');
      const adminId = escHtml(u.administracion_id||'1');
      const tagParts = [];
      if (rol) tagParts.push(`<span class="tag">${rol}</span>`);
      tagParts.push(`<span class="tag">Prioridad ${prioridad}</span>`);
      if (estado) tagParts.push(`<span class="tag">${estado}</span>`);
      const tagsHtml = tagParts.join('');
      return `
        <article class="user-card" data-email="${email}">
          <div class="user-card__head">
            <h4 class="user-card__name">${name}</h4>
            <span class="user-card__email">${email}</span>
          </div>
          ${tagsHtml ? `<div class="user-card__tags">${tagsHtml}</div>` : ''}
          <div class="user-card__meta">
            <div class="user-card__meta-item">
              <span class="user-card__meta-label">Departamento</span>
              <span>${departamento || '—'}</span>
            </div>
            <div class="user-card__meta-item">
              <span class="user-card__meta-label">Salones con prioridad</span>
              <span>${prioridadSalones || '—'}</span>
            </div>
            <div class="user-card__meta-item">
              <span class="user-card__meta-label">Extensión</span>
              <span>${extension || '—'}</span>
            </div>
            <div class="user-card__meta-item">
              <span class="user-card__meta-label">Administración</span>
              <span>${adminId || '—'}</span>
            </div>
          </div>
        </article>
      `;
    }).join('');
    listEl.classList.remove('is-empty');
    listEl.innerHTML = `
      <table class="user-table"><thead><tr><th>Nombre / Correo</th><th>Departamento</th><th>Rol</th><th>Prioridad</th><th>Salones con prioridad</th><th>Estado</th><th>Ext.</th><th>Admin</th></tr></thead><tbody>${rows}</tbody></table>
      <div class="user-card-list">${cards}</div>
    `;
    const syncSelection = email => {
      listEl.querySelectorAll('.u-row, .user-card').forEach(node => {
        if (!node || typeof node.dataset?.email === 'undefined') return;
        node.classList.toggle('selected', email && node.dataset.email === email);
      });
    };
    const handleSelection = email => {
      const current = email ? items.find(x => x.email === email) : null;
      if (selected && selected.email === email){
        selected = null;
        syncSelection('');
        clearUserForm();
        return;
      }
      if (!current){
        selected = null;
        syncSelection('');
        clearUserForm();
        return;
      }
      selected = current;
      syncSelection(email);
      fillUserForm(current);
    };
    listEl.querySelectorAll('.u-row').forEach(tr => {
      tr.onclick = ()=> handleSelection(tr.dataset.email || '');
    });
    listEl.querySelectorAll('.user-card').forEach(card => {
      card.onclick = ()=> handleSelection(card.dataset.email || '');
    });
    if (selected){
      const stillThere = items.find(x => x.email === selected.email);
      if (stillThere){
        selected = stillThere;
        syncSelection(selected.email);
      }else{
        selected = null;
        syncSelection('');
      }
    }
  };
  const modalMsg = (s)=>{ window.modal(s); };
  const clearUserForm = ()=>{
    ['u-email','u-nombre','u-dep','u-prio','u-ext'].forEach(id=>{ const el=document.getElementById(id); if(el) el.value=''; });
    const adminInput = document.getElementById('u-admin'); if (adminInput) adminInput.value = '1';
    const r = document.getElementById('u-rol'); if(r) r.value='';
    const e = document.getElementById('u-estado'); if(e) e.value='';
    syncPriorityCodes([]);
    if (prioPicker) prioPicker.value = '';
  };
  const fillUserForm = (u)=>{
    document.getElementById('u-email').value = u?.email||'';
    document.getElementById('u-nombre').value = u?.nombre||'';
    document.getElementById('u-dep').value = u?.departamento||'';
    document.getElementById('u-rol').value = u?.rol||'';
    document.getElementById('u-prio').value = String(Number(u?.prioridad||0));
    document.getElementById('u-estado').value = u?.estado||'';
    document.getElementById('u-ext').value = u?.extension||'';
    document.getElementById('u-admin').value = u?.administracion_id || '';
    const codes = Array.isArray(u?.prioridad_salones_list)
      ? u.prioridad_salones_list
      : String(u?.prioridad_salones||'').split(';');
    syncPriorityCodes(codes);
    if (prioPicker) prioPicker.value = '';
  };
  const load = ()=>{
    Busy.show('Cargando usuarios…');
    google.script.run
      .withSuccessHandler(r=>{ Busy.hide(); draw((r&&r.data)||[]); })
      .withFailureHandler(()=>{ Busy.hide(); modalMsg('No se pudieron cargar usuarios'); })
      .apiListUsuarios();
  };
  document.getElementById('u-save').onclick = ()=>{
    const prioridadRaw = document.getElementById('u-prio').value;
    const prioridadNum = prioridadRaw === '' ? NaN : Number(prioridadRaw);
    const payload = {
      email:    document.getElementById('u-email').value.trim(),
      nombre:   document.getElementById('u-nombre').value.trim(),
      departamento: document.getElementById('u-dep').value.trim(),
      rol:      document.getElementById('u-rol').value.trim(),
      prioridad:isNaN(prioridadNum) ? null : prioridadNum,
      prioridad_salones: '',
      estado:   document.getElementById('u-estado').value.trim(),
      extension:document.getElementById('u-ext').value.trim(),
      administracion_id: (document.getElementById('u-admin').value || '').trim()
    };
    if (!payload.email) return modalMsg('El correo es obligatorio.');
    if (!payload.nombre) return modalMsg('El nombre es obligatorio.');
    if (!payload.departamento) return modalMsg('El departamento es obligatorio.');
    if (!payload.rol) return modalMsg('Selecciona un rol.');
    if (payload.prioridad === null) return modalMsg('La prioridad es obligatoria.');
    const codes = getPriorityCodes();
    payload.prioridad_salones = codes.join(';');
    if (!payload.estado) return modalMsg('Selecciona un estado.');
    if (!payload.extension) return modalMsg('La extensión es obligatoria.');
    // Si hay selección y no hay cambios → no-op
    if (selected &&
        selected.email===payload.email &&
        (selected.nombre||'')===payload.nombre &&
        (selected.departamento||'')===payload.departamento &&
        (selected.rol||'')===payload.rol &&
        Number(selected.prioridad||0)===payload.prioridad &&
        (String(selected.prioridad_salones||'').trim()===payload.prioridad_salones) &&
        (selected.estado||'')===payload.estado &&
        (selected.extension||'')===payload.extension &&
        (String(selected.administracion_id||'1')===String(payload.administracion_id||'1'))){
      clearUserForm();
      const rows = listEl.querySelectorAll('.u-row'); rows.forEach(x=>x.classList.remove('selected')); selected=null;
      return modalMsg('No hay cambios que guardar.');
    }
    Busy.show(selected?'Guardando cambios…':'Guardando…');
    google.script.run
      .withSuccessHandler(r=>{ Busy.hide(); if(!r||!r.ok){ modalMsg(r&&r.msg||'No se pudo guardar'); return; } 
        clearUserForm();
        listEl.querySelectorAll('.u-row').forEach(x=>x.classList.remove('selected')); selected=null;
        load();
      })
      .withFailureHandler(()=>{ Busy.hide(); modalMsg('Error al guardar'); })
      .apiUpsertUsuario(payload);
  };
  document.getElementById('u-close').onclick = ()=> modal.hidden = true;
  modal.hidden = false;
  load();
}

// Lógica modal conserjes y asignar conserjes

function openConserjesModal(){
  if (!IS_GENERAL_ADMIN) return;
  const modalEl = document.getElementById('modalCon');
  const listEl  = document.getElementById('con-list');

  let selected = null;     // {codigo,nombre,email,telefono,activo} o null
  let snapshot = {};       // { codigo: conserje }

  const clearForm = ()=>{
    document.getElementById('con-nombre').value = '';
    document.getElementById('con-email').value  = '';
    document.getElementById('con-tel').value    = '';
  };

  const clearSelection = ()=>{
    selected = null;
    listEl.querySelectorAll('.con-row').forEach(x=>x.classList.remove('selected'));
  };

  const draw = (items=[])=>{
    if (!items.length){
      listEl.innerHTML = '<p style="padding:10px">No hay conserjes.</p>';
      return;
    }

    const rows = items.map(c => `
      <tr class="con-row" data-codigo="${c.codigo}">
        <td style="width:110px"><code>${c.codigo}</code></td>
        <td>${c.nombre}</td>
        <td>${c.email}</td>
        <td>${c.telefono||''}</td>
        <td>${c.activo?'<span class="tag">Activo</span>':'<span class="tag" style="background:#fee2e2;color:#991b1b">Inactivo</span>'}</td>
        <td style="width:120px">${c.activo? `<button class="btn btn-blue btn--sm con-del" data-codigo="${c.codigo}">Desactivar</button>` : ''}</td>
      </tr>
    `).join('');

    listEl.innerHTML = `
      <table>
        <thead><tr><th>Código</th><th>Nombre</th><th>Email</th><th>Teléfono</th><th>Estado</th><th></th></tr></thead>
        <tbody>${rows}</tbody>
      </table>`;

    // Selección + autollenado
    listEl.querySelectorAll('.con-row').forEach(tr=>{
      tr.onclick = ()=>{
        const codigo = tr.dataset.codigo;
        if (selected && selected.codigo === codigo){
          // Toggle off
          tr.classList.remove('selected');
          clearSelection();
          clearForm();
          return;
        }
        // Nueva selección
        listEl.querySelectorAll('.con-row').forEach(x=>x.classList.remove('selected'));
        tr.classList.add('selected');
        const row = items.find(x => x.codigo === codigo);
        selected = row || null;
        document.getElementById('con-nombre').value = row?.nombre || '';
        document.getElementById('con-email').value  = row?.email || '';
        document.getElementById('con-tel').value    = row?.telefono || '';
      };
    });

    // Desactivar (lógico)
    listEl.querySelectorAll('.con-del').forEach(b=>{
      b.onclick = (ev)=>{
        ev.stopPropagation();
        Busy.show('Actualizando…');
        google.script.run
          .withSuccessHandler(r=>{
            Busy.hide();
            if (!r || !r.ok){ window.modal('No se pudo actualizar'); return; }
            clearSelection();
            clearForm();
            load();
          })
          .withFailureHandler(()=>{
            Busy.hide();
            window.modal('Error');
          })
          .apiDeleteConserje(b.dataset.codigo);
      };
    });
  };

  const load = ()=>{
    Busy.show('Cargando…');
    google.script.run
      .withSuccessHandler(r=>{
        Busy.hide();
        const data = (r && r.data) || [];
        snapshot = {};
        data.forEach(c => { snapshot[c.codigo] = c; });
        draw(data);
      })
      .withFailureHandler(()=>{
        Busy.hide();
        window.modal('No se pudo cargar conserjes');
      })
      .apiListConserjes();
  };

  // Guardar = agregar o actualizar (según haya selección)
  document.getElementById('con-save').onclick = ()=>{
    const nombre = (document.getElementById('con-nombre').value||'').trim();
    const email  = (document.getElementById('con-email').value||'').trim().toLowerCase();
    const tel    = (document.getElementById('con-tel').value||'').trim();
    if (!nombre || !email) return window.modal('Nombre y correo son obligatorios');

    if (!selected){
      // Alta
      Busy.show('Agregando…');
      google.script.run
        .withSuccessHandler(r=>{
          Busy.hide();
          if (!r || !r.ok){ window.modal('No se pudo agregar'); return; }
          window.modal('Conserje agregado');
          clearForm();
          clearSelection();
          load();
        })
        .withFailureHandler(()=>{
          Busy.hide();
          window.modal('Error al agregar');
        })
        .apiAddConserje(nombre, email, tel);
      return;
    }

    // Edición (dif contra snapshot para escribir solo si cambia)
    const cur = snapshot[selected.codigo] || {};
    const fields = {};
    if ((cur.nombre||'')   !== nombre) fields.nombre   = nombre;
    if ((cur.email||'').toLowerCase() !== email) fields.email = email;
    if ((cur.telefono||'') !== tel)     fields.telefono = tel;

    if (Object.keys(fields).length === 0){
      window.modal('No hay cambios por guardar.');
      clearForm();
      clearSelection();
      return;
    }

    Busy.show('Guardando cambios…');
    google.script.run
      .withSuccessHandler(r=>{
        Busy.hide();
        if (!r || !r.ok){ window.modal((r && r.msg) || 'No se pudo guardar'); return; }
        window.modal(r.changed ? 'Cambios guardados' : 'No había cambios por guardar');
        clearForm();
        clearSelection();
        load();
      })
      .withFailureHandler(()=>{
        Busy.hide();
        window.modal('Error al guardar cambios');
      })
      .apiUpdateConserje(selected.codigo, fields);
  };

  document.getElementById('con-close').onclick = ()=> { modalEl.hidden = true; };
  modalEl.hidden = false;
  load();
}

let asignarReservaId = null;

function openAsignarModal(reservaId){
  asignarReservaId = reservaId;
  const modal = document.getElementById('modalAsignar');
  const sel = document.getElementById('selConserje');
  sel.innerHTML = '<option value="">[Seleccionar]</option>';
  Busy.show('Cargando conserjes…');
  google.script.run
    .withSuccessHandler(r=>{
      Busy.hide();
      const data = (r&&r.data)||[];
      sel.innerHTML = '<option value="">[Seleccionar]</option>' +
        data.filter(c=>c.activo).map(c=>`<option value="${c.codigo}">${c.nombre} (${c.codigo})</option>`).join('');
      modal.hidden = false;
    })
    .withFailureHandler(()=>{ Busy.hide(); modal('No se pudo cargar conserjes'); })
    .apiListConserjes();

  document.getElementById('btnAsignarOk').onclick = ()=>{
    const codigo = sel.value || '';
    if (!codigo) return modal('Selecciona un conserje');
    Busy.show('Asignando…');
    google.script.run
      .withSuccessHandler(r=>{
        Busy.hide();
        if (!r || !r.ok) { window.modal((r&&r.msg)||'No se pudo asignar'); return; }
        modal.hidden = true;
        // 1) Update inline inmediato
        const link = document.querySelector(`a.asignar-link[data-id="${asignarReservaId}"]`);
        if (link && r.conserje && r.conserje.nombre){
          link.textContent = r.conserje.nombre;
        }
        // 2) Refrescar fuentes para siguientes renders
        __CON_MAP__ = null;
        loadConserjeMap(()=> buscar());
      })
      .withFailureHandler(()=>{ Busy.hide(); window.modal('Error al asignar'); })
      .apiAsignarConserje(asignarReservaId, codigo);
  };
  document.getElementById('btnAsignarClose').onclick = ()=>{ modal.hidden = true; };
}

document.addEventListener('DOMContentLoaded', init);
</script>