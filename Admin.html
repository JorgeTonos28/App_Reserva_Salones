<!DOCTYPE html><html>
<head>
  <meta charset="utf-8" />
  <title>Reserva de Salones – Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script>(function(){try{var f=(window.top!==window.self);var s=Math.max(screen.width,screen.height)<=880;if(f&&s){window.top.location.href=window.location.href;}}catch(e){}})();</script>
  <?!= include_('css'); ?>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" referrerpolicy="no-referrer" />
</head>
<body class="container">
  <header class="card" style="text-align:center">
    <img id="logo" alt="Logo" style="height:100px"/>
    <h1 style="margin:6px 0 0">Administración Reserva de Salones</h1>
    <small>Versión <?= appVersion ?></small>
  </header>
  <section class="card">
    <div class="section-head">
      <h2 style="margin:0">Salones</h2>
      <div class="actions-inline">
        <button id="btnConserjes" class="btn btn-blue btn--sm" type="button" title="Gestionar conserjes" aria-label="Gestionar conserjes">Conserjes</button>
        <button id="btnUsuarios"  class="btn btn-blue btn--sm" type="button" title="Gestionar usuarios" aria-label="Gestionar usuarios">Usuarios</button>
      </div>
    </div>
    <div id="salones" class="table-overflow table-overflow--salones" data-empty-text="No hay salones configurados."></div>
  </section>

  <!-- Modal Conserjes -->
  <div id="modalCon" class="overlay" hidden>
    <div class="modal-card modal-card--md">
      <h3>Conserjes</h3>
      <div id="con-list" class="modal-scroll"></div>
      <div class="row g" style="margin-top:6px">
        <input id="con-nombre" placeholder="Nombre"/>
        <input id="con-email" placeholder="Correo"/>
        <input id="con-tel" placeholder="Teléfono"/>
        <button id="con-save" class="btn-blue" type="button">Guardar</button>
        <button id="con-close" class="btn btn-blue btn--sm" type="button">Cerrar</button>
      </div>
      <small class="muted">Selecciona un conserje de la lista para editar; clic de nuevo para deseleccionar. Si no hay selección, “Guardar” creará un nuevo registro.</small>
    </div>
  </div>

  <!-- Modal Usuarios -->
  <div id="modalUsers" class="overlay" hidden>
    <div class="modal-card modal-card--lg">
      <div class="modal-head">
        <h3>Usuarios</h3>
      </div>
      <div class="modal-body">
        <div id="users-list" class="table-overflow table-overflow--flat is-empty" data-empty-text="No hay usuarios registrados."></div>
        <small class="muted">Los campos marcados con <span class="required">*</span> son obligatorios.</small>
        <div class="user-form-grid">
          <div class="user-field">
            <label for="u-email">Correo <span class="required">*</span></label>
            <input id="u-email" type="email" placeholder="usuario@infotep.gob.do" required />
          </div>
          <div class="user-field">
            <label for="u-nombre">Nombre <span class="required">*</span></label>
            <input id="u-nombre" placeholder="Nombre completo" required />
          </div>
          <div class="user-field">
            <label for="u-dep">Departamento <span class="required">*</span></label>
            <input id="u-dep" placeholder="Departamento" required />
          </div>
          <div class="user-field">
            <label for="u-rol">Rol <span class="required">*</span></label>
            <select id="u-rol" required>
              <option value="">[Rol]</option>
              <option value="ADMIN">ADMIN</option>
              <option value="SOLICITANTE">SOLICITANTE</option>
            </select>
          </div>
          <div class="user-field">
            <label for="u-prio">Prioridad <span class="required">*</span></label>
            <input id="u-prio" type="number" min="0" placeholder="Ej: 0" required />
          </div>
          <div class="user-field">
            <label for="u-estado">Estado <span class="required">*</span></label>
            <select id="u-estado" required>
              <option value="">[Estado]</option>
              <option value="ACTIVO">ACTIVO</option>
              <option value="PENDIENTE">PENDIENTE</option>
              <option value="INACTIVO">INACTIVO</option>
            </select>
          </div>
          <div class="user-field">
            <label for="u-ext">Extensión <span class="required">*</span></label>
            <input id="u-ext" placeholder="Ej: 2239" required />
          </div>
          <div class="user-field">
            <label for="u-admin">Administración</label>
            <input id="u-admin" type="number" min="1" placeholder="Ej: 1" />
          </div>
        </div>
        <div class="user-priority-block">
          <div class="user-priority-title-row">
            <span class="user-priority-title">Salones con prioridad</span>
            <span class="user-priority-optional">Opcional</span>
          </div>
          <div id="u-prio-salones-list" class="chip-list" data-empty-text="Sin salones priorizados (opcional)"></div>
          <div class="user-priority-controls">
            <label class="sr-only" for="u-prio-salones-picker">Seleccionar salón con prioridad</label>
            <div class="chip-actions">
              <select id="u-prio-salones-picker">
                <option value="">[Seleccionar salón]</option>
              </select>
              <button id="u-prio-salones-add" class="btn btn-blue btn--sm" type="button">Agregar</button>
            </div>
          </div>
          <small id="u-prio-salones-hint" class="muted">Déjalo vacío si la prioridad aplica para todos los salones.</small>
          <input id="u-prio-salones" type="hidden" />
        </div>
      </div>
      <div class="modal-footer">
        <button id="u-save"  class="btn btn-blue btn--sm">Guardar</button>
        <button id="u-close" class="btn btn-blue btn--sm" type="button">Cerrar</button>
      </div>
    </div>
  </div>

  <!-- Sección Crear reserva (Admin) -->
  <section class="card">
    <div class="section-head">
      <h2 style="margin:0">Crear reserva (Admin)</h2>
      <small class="muted">Mismas reglas del formulario público</small>
    </div>
    <!-- Toggle anfitrión -->
    <div class="section">
      <div class="qline">
        <div class="section-title">¿El anfitrión eres tú?</div>
        <div class="actions-inline">
          <button id="a-hostYes" class="btn btn-green btn-toggle" type="button" aria-pressed="true">Sí</button>
          <button id="a-hostNo"  class="btn btn-red  btn-toggle" type="button" aria-pressed="false">No</button>
        </div>
      </div>
    </div>
    <div class="form-grid">
      <div class="form-item">
        <label for="a-fecha">Fecha</label>
        <input id="a-fecha" type="date" />
      </div>
      <div class="form-item">
        <label for="a-salon">Salón</label>
        <select id="a-salon"></select>
        <div id="a-restriccionHint" class="notice notice--warning" hidden></div>
        <div id="a-aprobacionHint" class="notice notice--info" hidden></div>
      </div>
      <div class="form-item">
        <label for="a-dur">Duración</label>
        <select id="a-dur"></select>
      </div>
      <div class="form-item">
        <div class="label-row">
          <label for="a-hora">Hora</label>
          <div class="label-actions">
            <button id="a-resetForm" class="icon-btn" type="button" title="Restablecer formulario" aria-label="Restablecer formulario">
              <i class="fa-solid fa-arrow-rotate-left" aria-hidden="true"></i>
            </button>
            <button id="a-refreshSlots" class="icon-btn" type="button" title="Refrescar disponibilidades" aria-label="Refrescar disponibilidades">
              <i class="fa-solid fa-arrows-rotate" aria-hidden="true"></i>
            </button>
          </div>
        </div>
        <select id="a-hora"></select>
      </div>
    </div>
    <div class="section">
      <div class="section-title">Datos del anfitrión</div>
      <div class="form-grid">
        <div class="form-item">
          <label for="a-nombre">Nombre</label>
          <div class="host-input-group">
            <input id="a-nombre" autocomplete="off" />
            <div id="a-hostSuggestions" class="host-suggestions" hidden role="listbox"></div>
          </div>
        </div>
        <div class="form-item">
          <label for="a-email">Correo</label>
          <input id="a-email" type="email" placeholder="jperez@infotep.gob.do" />
          <small id="a-emailError" class="error" hidden>Debe ser un correo @infotep.gob.do</small>
        </div>
        <div class="form-item"><label for="a-dep">Departamento</label><input id="a-dep" placeholder="Ej: Innovación"/></div>
        <div class="form-item">
          <label for="a-ext">Extensión</label>
          <input id="a-ext" inputmode="numeric" pattern="[0-9]*" placeholder="Ej: 2239"/>
          <small id="a-extError" class="error" hidden>Solo números (0–9).</small>
        </div>
        <div class="form-item form-item--full"><label for="a-evento">Nombre del evento</label><input id="a-evento" placeholder="Ej: Reunión de proyecto"/></div>
        <div class="form-item">
          <label for="a-cant">Cant. de personas <span id="a-capMaxTag" class="label-meta"></span></label>
          <input id="a-cant" type="number" min="1" placeholder="Ej: 15"/>
          <small id="a-cantError" class="error" hidden></small>
        </div>
        <div class="form-item"><label for="a-publico">Tipo de público</label>
          <select id="a-publico"><option value="">[Seleccionar]</option><option>Interno</option><option>Externo</option><option>Mixto</option></select>
        </div>
      </div>
    </div>
    <div class="actions">
      <button id="a-crear" class="btn-blue">Crear reserva</button>
    </div>
  </section>

  <section class="card">
    <div class="section-head">
      <h2 style="margin:0">Historial de reservas</h2>
      <div class="actions-inline" style="gap:10px;">
        <button id="btnReset" class="btn btn-blue btn--sm" type="button">Restablecer</button>
        <button id="btnExport" class="btn btn-blue btn--sm" type="button">Exportar a Sheets</button>
      </div>
    </div>
    <div class="filters-row">
      <div class="filter-box">
        <label for="f1">Fecha desde</label>
        <input id="f1" type="date" placeholder="Desde" />
      </div>
      <div class="filter-box">
        <label for="f2">Fecha hasta</label>
        <input id="f2" type="date" placeholder="Hasta" />
      </div>
      <div class="filter-box">
        <label for="fHora1">Hora desde</label>
        <input id="fHora1" type="time" placeholder="Hora desde" />
      </div>
      <div class="filter-box">
        <label for="fHora2">Hora hasta</label>
        <input id="fHora2" type="time" placeholder="Hora hasta" />
      </div>
    </div>
    <div class="filters-row" style="margin-top:10px;">
      <div class="filter-box">
        <label for="fSalon">Salón</label>
        <select id="fSalon">
          <option value="">[Todos los salones]</option>
        </select>
      </div>
      <div class="filter-box">
        <label for="fEstado">Estado</label>
        <select id="fEstado">
          <option value="">[Todos los estados]</option>
          <option value="PENDIENTE">Pendiente</option>
          <option value="APROBADA">Aprobada</option>
          <option value="CANCELADA">Cancelada</option>
        </select>
      </div>
      <div class="filter-box">
        <label for="fSolicitante">Solicitante</label>
        <select id="fSolicitante">
          <option value="">[Todos los solicitantes]</option>
        </select>
      </div>
      <div class="filter-box">
        <label for="fConserje">Conserje</label>
        <select id="fConserje">
          <option value="">[Todos los conserjes]</option>
        </select>
      </div>
    </div>
    <div class="filters-row filters-row--end" style="margin-top:10px;">
      <div class="filter-box" style="flex:1 1 320px;">
        <label for="fTexto">Búsqueda por texto</label>
        <input id="fTexto" placeholder="Buscar en cualquier campo (separa por espacios)" />
      </div>
      <div class="filter-actions">
        <button id="btnBuscar" class="btn-blue btn--sm" type="button">Buscar</button>
      </div>
    </div>
    <div id="reservas" style="margin-top:16px;"></div>
  </section>

  <!-- Modal Asignar Conserjes -->
  <div id="modalAsignar" class="overlay" hidden>
    <div class="modal-card">
      <h3>Asignar conserje</h3>
      <div class="row g">
        <select id="selConserje"></select>
      </div>
      <div class="row g" style="margin-top:10px">
        <button id="btnAsignarOk" class="btn-blue">Asignar</button>
        <button id="btnAsignarClose" class="btn-blue" type="button">Cerrar</button>
      </div>
    </div>
  </div>

  <!-- Overlay global -->
  <div id="overlay" class="overlay" hidden>
    <div class="spinner" role="status" aria-label="Cargando"></div>
    <div class="overlay-msg" aria-live="polite">Cargando…</div>
  </div>

  <!-- Modal -->
  <div id="modal" class="overlay" hidden>
    <div class="modal-card">
      <h3 id="mTitle">Mensaje</h3>
      <p id="mBody"></p>
      <div class="row g"><button id="mOk" class="btn-blue">Aceptar</button></div>
    </div>
  </div>
  <? if (footerSignature && (footerSignature.url || footerSignature.credits)) { ?>
    <footer class="site-footer">
      <? if (footerSignature.url) { ?>
        <img src="<?= footerSignature.url ?>" alt="Firma institucional" class="site-footer__signature" style="max-width: <?= footerSignature.width ?>px;" />
      <? } ?>
      <? if (footerSignature.credits) { ?>
        <div class="site-footer__credits"><?= footerSignature.credits ?></div>
      <? } ?>
    </footer>
  <? } ?>

  <script>
    window.__LOGO_URL__ = "<?= logoUrl ?>";
    window.__ME__ = {
      email: "<?= me && me.email ?>",
      nombre: "<?= me && me.nombre ?>",
      departamento: "<?= me && me.departamento ?>",
      extension: "<?= me && me.extension ?>",
      rol: "<?= me && me.rol ?>",
      estado: "<?= me && me.estado ?>",
      administracion_id: "<?= me && me.administracion_id || '' ?>",
      prioridad: <?= Number(me && me.prioridad || 0) ?>,
      prioridad_salones: <?= JSON.stringify(me && me.prioridad_salones || []) ?>,
      prioridadSalones: <?= JSON.stringify(me && me.prioridad_salones || []) ?>,
      prioridad_salones_raw: "<?= me && me.prioridad_salones_raw || '' ?>"
    };
    window.__ADMIN_PRESET__ = <?= JSON.stringify(initialFilters || {}) ?>;
    window.__CON_UNASSIGNED__ = "<?= conserjeUnassignedCode ?>";
  </script>

  <?!= include_('admin.js'); ?>
</body></html>
