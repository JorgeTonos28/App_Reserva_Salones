<script>
/* ========= Utils ========= */
const $ = s => document.querySelector(s);
const ME = (window.__ME__ || { prioridad: 0, email: '' });
function getPrioridadSalonesList(){
  const seen = {};
  const out = [];
  const candidates = [];
  if (Array.isArray(ME.prioridad_salones)) candidates.push(ME.prioridad_salones);
  if (Array.isArray(ME.prioridadSalones)) candidates.push(ME.prioridadSalones);
  candidates.forEach(list => {
    list.forEach(code => {
      const token = String(code||'').trim().toUpperCase();
      if (token && !seen[token]){ seen[token]=true; out.push(token); }
    });
  });
  if (!out.length && typeof ME.prioridad_salones_raw === 'string'){
    String(ME.prioridad_salones_raw||'').split(';').forEach(code => {
      const token = String(code||'').trim().toUpperCase();
      if (token && !seen[token]){ seen[token]=true; out.push(token); }
    });
  }
  return out;
}
function getEffectivePriorityForSalon(salonId){
  const base = Number(ME.prioridad) || 0;
  if (base <= 0) return base;
  const list = getPrioridadSalonesList();
  if (!list.length) return base;
  const target = String(salonId||'').trim().toUpperCase();
  if (!target) return base;
  return list.includes(target) ? base : 0;
}
let __SALONES__ = [];      // cache local de salones (id, nombre, capacidad, habilitado)
let __extHintTimer__ = 0;  // timer para ocultar hint de extensi√≥n tras un intento inv√°lido
let __SLOT_INFO__ = {};    // cache local de slots con metadata de disponibilidad
let __SALON_CFG__ = {};    // { id: {duracion_min, duracion_max, duracion_step, horario_inicio, horario_fin} }
const DEFAULT_DUR_CFG_PUBLIC = {
  min: Number(window.__DUR_MIN__ || 30),
  max: Number(window.__DUR_MAX__ || 240),
  step: Number(window.__DUR_STEP__ || 30)
};

function escHtml(str){
  return String(str || '').replace(/[&<>"']/g, ch => ({
    '&': '&amp;',
    '<': '&lt;',
    '>': '&gt;',
    '"': '&quot;',
    "'": '&#39;'
  }[ch] || ch));
}

function isPublicoExternoOMixto(tipo){
  const t = String(tipo || '').trim().toLowerCase();
  return t === 'externo' || t === 'mixto';
}

function normalizeHHMM(str){
  const m = String(str||'').trim().match(/^(\d{1,2}):(\d{1,2})$/);
  if (!m) return '';
  const h = Math.max(0, Math.min(23, parseInt(m[1],10) || 0));
  const mi = Math.max(0, Math.min(59, parseInt(m[2],10) || 0));
  return `${String(h).padStart(2,'0')}:${String(mi).padStart(2,'0')}`;
}

function hhmmToMinutes(str){
  const m = String(str||'').trim().match(/^(\d{1,2}):(\d{1,2})$/);
  if (!m) return NaN;
  const h = parseInt(m[1], 10) || 0;
  const mi = parseInt(m[2], 10) || 0;
  return (Math.max(0, h) * 60) + Math.max(0, Math.min(59, mi));
}

function parseSalonRestrictionMeta(raw){
  const text = String(raw||'').trim();
  if (!text) return { intervals:[], requiresApproval:false, raw:'' };
  const parts = text.split(';').map(p=>String(p||'').trim()).filter(Boolean);
  const intervals = [];
  let requiresApproval = false;
  parts.forEach(part => {
    const up = part.toUpperCase();
    if (up === 'CONFIRM' || up === 'COFNIRM'){
      requiresApproval = true;
      return;
    }
    const match = part.match(/^(\d{1,2}:\d{2})\s*-\s*(\d{1,2}:\d{2})$/);
    if (!match) return;
    const ini = normalizeHHMM(match[1]);
    const fin = normalizeHHMM(match[2]);
    if (!ini || !fin) return;
    if (ini === fin) return;
    intervals.push(`${ini}-${fin}`);
  });
  return { intervals, requiresApproval, raw:text };
}

function applySalonMetaHints(){
  const salonId = ($('#selSalon') && $('#selSalon').value) || '';
  const metaMap = (typeof window !== 'undefined' && window.__SALON_META__) || {};
  const meta = metaMap[salonId] || { intervals:[], requiresApproval:false };
  const restrEl = document.getElementById('hintRestriccion');
  if (restrEl){
    if (meta.intervals && meta.intervals.length){
      restrEl.textContent = `Horarios restringidos: ${meta.intervals.join(', ')}`;
      restrEl.hidden = false;
    } else {
      restrEl.hidden = true;
      restrEl.textContent = '';
    }
  }
  const apprEl = document.getElementById('hintAprobacion');
  if (apprEl){
    if (meta.requiresApproval){
      apprEl.textContent = 'Este sal√≥n es restringido y requiere aprobaci√≥n de la administraci√≥n. La solicitud quedar√° pendiente hasta ser revisada.';
      apprEl.hidden = false;
    } else {
      apprEl.hidden = true;
      apprEl.textContent = '';
    }
  }
}

function updateSalonHint(){
  const hint = $('#hintSalon');
  if (!hint) return;
  const sel = $('#selSalon');
  const salonId = sel ? (sel.value || '') : '';
  if (!salonId){
    hint.textContent = '';
    return;
  }
  const opt = sel && sel.selectedOptions && sel.selectedOptions[0];
  if (opt && opt.disabled){
    hint.textContent = 'Este sal√≥n est√° deshabilitado temporalmente.';
    return;
  }
  const salon = (__SALONES__||[]).find(s => String(s.id) === String(salonId));
  const pieces = [];
  if (salon && Number(salon.capacidad)){
    pieces.push(`Capacidad m√°xima: ${salon.capacidad}`);
  }
  const basePrio = Number(ME.prioridad) || 0;
  if (basePrio > 0){
    const list = getPrioridadSalonesList();
    if (!list.length){
      pieces.push(`Tu prioridad (${basePrio}) est√° activa en todos los salones.`);
    } else if (list.includes(String(salonId).trim().toUpperCase())){
      pieces.push(`Tu prioridad (${basePrio}) est√° activa para este sal√≥n.`);
    } else {
      pieces.push('Para este sal√≥n tu prioridad se considera 0.');
    }
  }
  hint.textContent = pieces.join(' ');
}

/* Overlay */
const Busy = (()=>{ 
  let n=0;
  const el=()=>$('#overlay');
  function show(msg){
    const o=el(); if(!o) return;
    const m=o.querySelector('.overlay-msg'); if (m) m.textContent = msg||'Procesando‚Ä¶';
    o.hidden=false; n++;
  }
  function hide(){
    const o=el(); if(!o) return;
    n=Math.max(0,n-1);
    if(!n) o.hidden=true;
  }
  function reset(){ const o=el(); if(!o) return; n=0; o.hidden=true; }
  return { show, hide, reset };
})();

/* Modal */
function modal(msg, title, opts){
  const modalEl = $('#modal');
  const body = $('#mBody');
  const okBtn = $('#mOk');
  $('#mTitle').textContent = title || 'Aviso';
  if (body){
    if (opts && opts.html){
      body.innerHTML = msg || '';
    } else {
      body.textContent = msg || '';
    }
  }
  if (modalEl) modalEl.hidden = false;
  if (okBtn){
    okBtn.onclick = () => {
      if (modalEl) modalEl.hidden = true;
    };
  }
}

function showBlockedSlotMessage(slotInfo){
  if (!slotInfo) return false;

  if (slotInfo.restringido || String(slotInfo.motivoRestriccion||'').toUpperCase()==='RESTRICCION'){
    modal('Este horario est√° restringido para este sal√≥n. Selecciona otro intervalo.');
    return true;
  }

  const currentSalonEl = $('#selSalon');
  const currentSalonId = currentSalonEl ? (currentSalonEl.value || '') : '';
  const userPrio = getEffectivePriorityForSalon(currentSalonId);
  const ocupantes = Array.isArray(slotInfo.ocupantes) ? slotInfo.ocupantes : [];
  const motivo = String(slotInfo.motivoConciliacion || '').toUpperCase();
  const hayEventoExterno = (motivo === 'PUBLICO_EXTERNO') || ocupantes.some(o => isPublicoExternoOMixto(o.publico_tipo));
  const hayMismaPrioridad = (motivo === 'MISMA_PRIORIDAD') || ocupantes.some(o => Number(o.prioridad || 0) === userPrio);
  const rawMaxPrio = (slotInfo.maxPrio == null || slotInfo.maxPrio === '') ? null : Number(slotInfo.maxPrio);
  const maxPrio = (Number.isFinite ? Number.isFinite(rawMaxPrio) : isFinite(rawMaxPrio)) ? rawMaxPrio : null;
  const usuarioTieneMenorPrioridad = maxPrio !== null && userPrio < maxPrio;

  if ((!hayEventoExterno && !hayMismaPrioridad) || (usuarioTieneMenorPrioridad && !hayMismaPrioridad)) {
    return false;
  }

  const items = ocupantes.map(o => {
    const nombre = escHtml(o.nombre || o.email || 'Reservante');
    const email = o.email ? `<a href="mailto:${escHtml(o.email)}">${escHtml(o.email)}</a>` : 'Sin correo disponible';
    const evento = o.evento ? `<div class="muted">Evento: ${escHtml(o.evento)}</div>` : '';
    const publico = o.publico_tipo ? `<div class="muted">Tipo de p√∫blico: ${escHtml(o.publico_tipo)}</div>` : '';
    const horario = `${escHtml(o.inicio || '')} - ${escHtml(o.fin || '')}`;
    const prioridad = escHtml(String(o.prioridad || 0));
    return `<li><strong>${nombre}</strong><br/>Correo: ${email}<br/>Horario: ${horario}<br/>Prioridad: ${prioridad}${evento}${publico}</li>`;
  }).join('');

  const listaHtml = items ? `<ul style="padding-left:18px;margin:8px 0;">${items}</ul>` : '';

  if (hayEventoExterno){
    const html = `
      <p>Este horario ya est√° reservado para un evento con p√∫blico externo o mixto.</p>
      ${listaHtml}
      <p>Debes coordinar con la(s) persona(s) anfitriona(s) para que cancelen la reserva antes de que puedas agendar este horario.</p>
    `;
    modal(html, 'Horario reservado', { html: true });
    return true;
  }

  if (userPrio <= 0) return false;

  const html = `
    <p>Este horario ya est√° reservado por otra persona con la misma prioridad.</p>
    ${listaHtml}
    <p>Debes coordinar con la otra parte para que cancele su reserva y puedas agendar este horario.</p>
  `;
  modal(html, 'Horario reservado', { html: true });
  return true;
}

/* Estado para llamadas */
let debounceTimer = null;
let reqSeq = 0;

/* Helpers */
function normalizeRes(r){
  if (typeof r === 'string') {
    try{ r = JSON.parse(r); }catch(e){ r = null; }
  }
  return r || {};
}

/* ===== Salones ===== */
function loadSalones(){
  Busy.show('Cargando salones‚Ä¶');
  google.script.run
    .withSuccessHandler(res => {
      Busy.hide();
      res = normalizeRes(res);
      const data = Array.isArray(res.data) ? res.data : (Array.isArray(res) ? res : []);
      __SALONES__ = data || [];
      const sel = $('#selSalon');
      const opts = ['<option value="">[Seleccionar]</option>']
        .concat(data.map(s => `<option value="${s.id}" ${s.habilitado ? '' : 'disabled'}>${s.nombre}${s.habilitado ? '' : ' (Deshabilitado)'}</option>`));
      sel.innerHTML = opts.join('');
      $('#hora').innerHTML = '';

      // Mapa local de capacidades para usar en validaciones/hints sin consultar al servidor
      window.__SALON_CAPS__ = {};
      window.__SALON_META__ = {};
      __SALON_CFG__ = {};
      data.forEach(s => {
        window.__SALON_CAPS__[s.id] = Number(s.capacidad) || 0;
        window.__SALON_META__[s.id] = parseSalonRestrictionMeta(s.restriccion);
        __SALON_CFG__[s.id] = {
          duracion_min: Number(s.duracion_min||30),
          duracion_max: Number(s.duracion_max||240),
          duracion_step: Number(s.duracion_step||30),
          horario_inicio: s.horario_inicio,
          horario_fin: s.horario_fin
        };
      });

      // Al cargar, limpia el tag de capacidad
      const tag = document.getElementById('capMaxTag');
      if (tag) tag.textContent = '';
      // Al cargar salones, tambi√©n renderizamos las opciones de duraci√≥n desde Config
      renderDurationsFromConfig();

      $('#selSalon').addEventListener('change', ()=>{
        updateSalonHint();
        applySalonMetaHints();
        renderDurationsFromConfig();
      }, { once:false });
      updateSalonHint();
      applySalonMetaHints();
    })
    .withFailureHandler(() => { Busy.hide(); modal('No se pudieron cargar los salones'); })
    .apiListSalones();
}

/* ===== Disponibilidad (con debounce + timeout + cancelaci√≥n l√≥gica) ===== */
function scheduleRefreshSlots(){
  clearTimeout(debounceTimer);
  debounceTimer = setTimeout(refreshSlots, 200);
}

function refreshSlots(){
  const salonId = $('#selSalon').value || '';
  const fecha   = $('#fecha').value || '';
  const dur     = Number($('#dur').value || 0);
  const prio = getEffectivePriorityForSalon(salonId);

  if (!salonId || !fecha || !dur){
    $('#hora').innerHTML = '';
    updateSalonHint();
    // Sin sal√≥n seleccionado, quita meta y error de capacidad si existiera
    const tag = document.getElementById('capMaxTag');
    if (tag) tag.textContent = '';
    const capErr = document.getElementById('cantError');
    if (capErr){ capErr.hidden = true; capErr.textContent = ''; }
    $('#cant')?.classList.remove('input-error');
    Busy.reset();
    __SLOT_INFO__ = {};
    if (typeof window !== 'undefined'){ window.__SLOT_INFO__ = __SLOT_INFO__; }
    applySalonMetaHints();
    return;
  }

  const mySeq = ++reqSeq;
  Busy.show('Verificando disponibilidad‚Ä¶');

  // Timeout de seguridad: si en 8s no volvi√≥, cancelamos visualmente
  let timeoutId = setTimeout(()=>{
    if (mySeq === reqSeq){ // sigue siendo la solicitud activa
      Busy.reset();
      modal('No se pudo confirmar la disponibilidad (tiempo de espera).');
      __SLOT_INFO__ = {};
      if (typeof window !== 'undefined'){ window.__SLOT_INFO__ = __SLOT_INFO__; }
    }
  }, 8000);

  google.script.run
    .withSuccessHandler(r => {
      if (mySeq !== reqSeq){ clearTimeout(timeoutId); return; } // lleg√≥ tarde
      Busy.hide();
      clearTimeout(timeoutId);

      r = normalizeRes(r);
      let arr = Array.isArray(r.data) ? r.data : (Array.isArray(r) ? r : []);
      if (!Array.isArray(arr)){
        $('#hora').innerHTML = '';
        modal('No se pudo confirmar la disponibilidad.');
        __SLOT_INFO__ = {};
        if (typeof window !== 'undefined'){ window.__SLOT_INFO__ = __SLOT_INFO__; }
        return;
      }

      const cfgSalon = (__SALON_CFG__||{})[salonId];
      if (cfgSalon){
        const cfgIni = hhmmToMinutes(cfgSalon.horario_inicio);
        const cfgFin = hhmmToMinutes(cfgSalon.horario_fin);
        if (!isNaN(cfgIni) && !isNaN(cfgFin) && cfgFin > cfgIni){
          arr = arr.filter(s => {
            const iniMin = hhmmToMinutes(s.inicio);
            const finMin = hhmmToMinutes(s.fin);
            if (isNaN(iniMin) || isNaN(finMin)) return true;
            return iniMin >= cfgIni && finMin <= cfgFin;
          });
        }
      }

      // Filtrar horas pasadas si la fecha es hoy
      const todayYMD = (()=>{ const d=new Date(); return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;})();
      const isToday = (fecha === todayYMD);
      const nowMin  = (new Date()).getHours()*60 + (new Date()).getMinutes();
      const toMin = (hhmm)=>{ const [h,m]=hhmm.split(':').map(Number); return h*60+m; };

      __SLOT_INFO__ = {};
      arr.forEach(s => { __SLOT_INFO__[s.inicio] = s; });
      if (typeof window !== 'undefined'){ window.__SLOT_INFO__ = __SLOT_INFO__; }

      const first = '<option value="">[Seleccionar]</option>';
      const opts = arr
        .filter(s => !isToday || toMin(s.inicio) > nowMin)   // << solo futuros si es hoy
        .map(s => {
        const ocupado = !s.disponible;
        const rawMax = (s.maxPrio==null || s.maxPrio==='') ? null : Number(s.maxPrio);
        const maxP = (Number.isFinite ? Number.isFinite(rawMax) : isFinite(rawMax)) ? rawMax : null;
        const puede = !!s.seleccionable;
        const userLowerThanMax = maxP !== null && prio < maxP;
        const motivo = String(s.motivoConciliacion || '').toUpperCase();
        let note = '';
        const esRestriccion = !!s.restringido || String(s.motivoRestriccion||'').toUpperCase()==='RESTRICCION';
        if (ocupado){
          if (!puede){
            if (motivo === 'PUBLICO_EXTERNO'){
              note = userLowerThanMax ? ' (reservado)' : ' (evento externo ‚Äì coordinar)';
            } else if (motivo === 'MISMA_PRIORIDAD' && prio > 0){
              note = ' (reservado ‚Äì coordinar)';
            } else if (userLowerThanMax || prio > 0 || maxP!=null) {
              note = ' (reservado)';
            }
          } else {
            note = ' (ocupado ‚Äì puedes reasignar)';
          }
        }
        if (esRestriccion){
          note = ' (horario restringido)';
        }
        const label = `${s.inicio} - ${s.fin}${note}`;
        const disableOption = esRestriccion || (!puede && (userLowerThanMax || prio <= 0));
        const disabledAttr = disableOption ? 'disabled' : '';
        return `<option value="${s.inicio}" ${disabledAttr}>${label}</option>`;
      }).join('');

      $('#hora').innerHTML = first + opts;
      $('#hora').value = ''; // que arranque sin selecci√≥n

      // DEBUG: imprime lo que vino del server y lo que se pint√≥
      try {
        console.log('[DBG] disponibilidad raw:', arr);
        const optStats = Array.from($('#hora').options).map(o => ({ text:o.text, value:o.value, disabled:o.disabled }));
        console.log('[DBG] hora options:', optStats);
        console.log('[DBG] ME:', ME);
      } catch(e){}

      updateSalonHint();
      applySalonMetaHints();

      // Actualiza el meta inline "(m√°x N)" en el label
      const tag = document.getElementById('capMaxTag');
      if (tag){
        const cap = (window.__SALON_CAPS__||{})[salonId] || 0;
        tag.textContent = cap ? `(m√°x ${cap})` : '';
      }
    })
    .withFailureHandler(() => {
      if (mySeq !== reqSeq){ clearTimeout(timeoutId); return; }
      Busy.hide();
      clearTimeout(timeoutId);
      modal('No se pudo confirmar la disponibilidad.');
      __SLOT_INFO__ = {};
      if (typeof window !== 'undefined'){ window.__SLOT_INFO__ = __SLOT_INFO__; }
    })
    .apiListDisponibilidad(fecha, salonId, dur, getEffectivePriorityForSalon(salonId));
}

function verifySelectedSlot(){
  const salonId = $('#selSalon').value || '';
  const fecha   = $('#fecha').value || '';
  const dur     = Number($('#dur').value || 0);
  const inicio  = $('#hora').value || '';
  if (!salonId || !fecha || !dur || !inicio) return;

  const slotInfo = (__SLOT_INFO__ || {})[inicio];
  if (showBlockedSlotMessage(slotInfo)){
    $('#hora').value = '';
    return;
  }

  // Usuarios con prioridad efectiva > 0 pueden seleccionar aunque est√© ocupado (no alertar)
  if (getEffectivePriorityForSalon(salonId) > 0) return;

  Busy.show('Confirmando intervalo‚Ä¶');
  google.script.run
    .withSuccessHandler(r=>{
      Busy.hide();
      if (!r || r.ok !== true) return;
      if (!r.disponible){
        const motivo = String(r.motivo||'').toUpperCase();
        if (motivo === 'RESTRICCION'){
          modal('Este sal√≥n no permite reservas en el horario seleccionado. Elige otro intervalo.');
        } else {
          modal('Ese intervalo ya no est√° disponible. Elige otra hora.');
        }
        const sel = $('#hora');
        const opt = sel.querySelector(`option[value="${inicio}"]`);
        if (opt) opt.disabled = true;
        sel.value = '';
        scheduleRefreshSlots();
      }
    })
    .withFailureHandler(()=>{ Busy.hide(); /* silencio */ })
    .apiCheckSlot(fecha, salonId, inicio, dur, getEffectivePriorityForSalon(salonId));
}

/* ===== Crear reserva ===== */
function reservar(){
  const p = {
    salon_id: $('#selSalon').value,
    fecha: $('#fecha').value,
    hora_inicio: $('#hora').value,
    duracion_min: Number($('#dur').value || 0),
    nombre: $('#nombre').value.trim(),
    email: ($('#email').value||'').trim(),
    departamento: $('#depto').value.trim(),
    extension: $('#ext').value.trim(),
    cant_personas: $('#cant').value,
    evento_nombre: $('#evento').value.trim(),
    publico_tipo: $('#publico').value
  };
  if (!p.salon_id || !p.fecha || !p.hora_inicio || !p.duracion_min ||
      !p.nombre || !p.email || !p.departamento || !p.extension || !p.cant_personas || !p.evento_nombre){
    return modal('Completa todos los campos obligatorios.');
  }
  // Dominio estricto
  if (!/@infotep\.gob\.do$/i.test(p.email||'')){
    const hint = document.getElementById('emailError'); if (hint) hint.hidden = false;
    return modal('El correo del anfitri√≥n debe ser del dominio @infotep.gob.do');
  }
  const slotInfo = (__SLOT_INFO__ || {})[p.hora_inicio];
  if (showBlockedSlotMessage(slotInfo)){
    $('#hora').value = '';
    return;
  }
  // --- Pre-chequeo duro para prioridad 0 ---
  const prioSalon = getEffectivePriorityForSalon(p.salon_id);
  if (prioSalon <= 0){
    Busy.show('Verificando disponibilidad‚Ä¶');
    google.script.run
      .withSuccessHandler(r=>{
        Busy.hide();
        if (!r || r.ok !== true){
          return modal('No se pudo confirmar la disponibilidad.');
        }
        if (!r.disponible){
          modal('Ese intervalo ya est√° reservado. Por favor elige otro.');
          // Marca el slot como no seleccionable y refresca
          const sel = $('#hora');
          const opt = sel.querySelector(`option[value="${p.hora_inicio}"]`);
          if (opt) opt.disabled = true;
          sel.value = '';
          scheduleRefreshSlots();
          return;
        }
        // Disponible: proceder a crear
        crearReserva_(p);
      })
      .withFailureHandler(()=>{ Busy.hide(); modal('No se pudo confirmar la disponibilidad.'); })
      .apiCheckSlot(p.fecha, p.salon_id, p.hora_inicio, p.duracion_min, prioSalon);
  } else {
    // Con prioridad > 0: crear directo
    crearReserva_(p);
  }
}

function crearReserva_(p){
  Busy.show('Creando reserva‚Ä¶');
  google.script.run
    .withSuccessHandler(r=>{
      Busy.hide();
      r = normalizeRes(r);
      if (r && r.ok){
        const estado = String(r.estado||'').toUpperCase();
        if (estado === 'PENDIENTE' || r.requiere_aprobacion){
          modal('Solicitud registrada. La reserva quedar√° pendiente de aprobaci√≥n. Recibir√°s un correo cuando la administraci√≥n la revise.');
        } else {
          modal('¬°Reserva creada! Recibir√°s un correo de confirmaci√≥n.');
        }
        resetReservaForm();      // üëà limpiar formulario
        listar();
        // (opcional) no refrescar slots si ya reseteamos todo; si prefieres, deja esta l√≠nea
      } else {
        modal((r && r.msg) || 'No se pudo crear la reserva');
        // Si fall√≥ por disponibilidad, refresca para que el usuario vea el estado real
        scheduleRefreshSlots();
      }
    })
    .withFailureHandler(()=>{ Busy.hide(); modal('Error al crear la reserva'); })
    .apiCrearReserva(p);
}

function resetReservaForm(){
  // Helpers
  const todayYMD = () => {
    const d = new Date();
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,'0');
    const dd = String(d.getDate()).padStart(2,'0');
    return `${y}-${m}-${dd}`;
  };

  // Selecci√≥n
  const selSalon = $('#selSalon');
  if (selSalon) selSalon.value = '';

  const fecha = $('#fecha');
  if (fecha) fecha.value = todayYMD();

  const dur = $('#dur');
  if (dur) dur.value = (dur.querySelector('option')?.value || '30'); // primer option o 30

  const hora = $('#hora');
  if (hora) hora.innerHTML = '<option value="">[Seleccionar]</option>';

  updateSalonHint();
  const restrHint = document.getElementById('hintRestriccion');
  if (restrHint){ restrHint.hidden = true; restrHint.textContent = ''; }
  const apprHint = document.getElementById('hintAprobacion');
  if (apprHint){ apprHint.hidden = true; apprHint.textContent = ''; }

  // Datos del solicitante
  const nombre = $('#nombre');        if (nombre) nombre.value = '';
  const depto  = $('#depto');         if (depto)  depto.value  = '';
  const ext    = $('#ext');           if (ext){ ext.value=''; ext.classList.remove('input-error'); }
  const extErr = $('#extError');      if (extErr) extErr.hidden = true;
  const cant   = $('#cant');          if (cant)   cant.value   = '';

  // Detalles del evento
  const evento = $('#evento');        if (evento) evento.value = '';
  const publico= $('#publico');       if (publico) publico.value = ''; // [Seleccionar]

  // Estado interno de disponibilidad
  reqSeq = 0;                         // descarta solicitudes en vuelo
  Busy.reset();
  applySalonMetaHints();
}

/* ===== Mis reservas ===== */
function drawMisReservas(arr){
  const el = $('#misreservas');
  if (!Array.isArray(arr)){
    el.innerHTML = '<p>Ocurri√≥ un error al cargar las reservas.</p>';
    return;
  }
  if (!arr.length){
    el.innerHTML = '<p>No tienes reservas en el rango seleccionado.</p>';
    return;
  }

  // Helpers fecha/hora -> Date local
  const toDateLocal = (ymd, hhmm) => {
    // ymd: 'YYYY-MM-DD', hhmm: 'HH:mm'
    const [y,m,d] = String(ymd||'').split('-').map(n=>parseInt(n,10));
    const [hh,mi] = String(hhmm||'').split(':').map(n=>parseInt(n,10));
    return new Date(y, (m||1)-1, d||1, hh||0, mi||0, 0, 0);
  };
  const now = new Date();
  const canCancel = (r) => {
    // P√∫blico: permitir cancelaci√≥n hasta antes de la hora de inicio
    const start = toDateLocal(r.fecha, r.hora_inicio);
    const estado = String(r.estado||'').toUpperCase();
    if (estado === 'PENDIENTE'){
      return start.getTime() > now.getTime();
    }
    return start.getTime() > now.getTime() && estado === 'APROBADA';
  };

  const fmtDateDMY = (ymd) => {
    const [y,m,d] = String(ymd||'').split('-');
    if (!y||!m||!d) return ymd||'';
    return `${d}/${m}/${y}`;
  };
  const fmt12 = (hhmm) => {
    if (!/^\d{2}:\d{2}$/.test(hhmm||'')) return hhmm||'';
    let [h, m] = hhmm.split(':').map(n => parseInt(n,10));
    const am = h < 12;
    h = (h % 12) || 12;
    const hh = String(h).padStart(2,'0');
    return `${hh}:${String(m).padStart(2,'0')} ${am?'a.m.':'p.m.'}`;
  };

  const rows = arr.map(r=>{
    const fecha = fmtDateDMY(r.fecha);
    const hora  = `${fmt12(r.hora_inicio)} - ${fmt12(r.hora_fin)}`;
    const cons  = (r.conserje_nombre && r.conserje_nombre.trim()) ? r.conserje_nombre : 'N/A';
    const estStr = String(r.estado||'');
    let estNic = estStr;
    let estCls = 'pill pill--other';
    if (estStr.toUpperCase()==='APROBADA'){ estNic='Aprobada'; estCls='pill pill--ok'; }
    else if (estStr.toUpperCase()==='CANCELADA'){ estNic='Cancelada'; estCls='pill pill--bad'; }
    else if (estStr.toUpperCase()==='PENDIENTE'){ estNic='Pendiente'; estCls='pill pill--pending'; }

    const actionBtn = canCancel(r)
      ? `<button class="btn-blue btn--sm btn-cancel" data-token="${r.token}" data-estado="${estStr}">${estStr.toUpperCase()==='PENDIENTE'?'Cancelar solicitud':'Cancelar'}</button>`
      : '';

    return `
      <tr>
        <td data-th="Fecha"><span class="val">${fecha}</span></td>
        <td data-th="Hora"><span class="val">${hora}</span></td>
        <td data-th="Sal√≥n"><span class="val">${r.salon_nombre}</span></td>
        <td data-th="Evento"><span class="val">${r.evento_nombre||''}</span></td>
        <td data-th="Conserje"><span class="val">${cons}</span></td>
        <td data-th="Estado"><span class="${estCls}">${estNic}</span></td>
        <td data-th=""><span class="val">${actionBtn}</span></td>
      </tr>`;
  }).join('');

  el.innerHTML = `
    <div class="cards-area">
    <table class="resp-table">
      <thead>
        <tr>
          <th>Fecha</th><th>Hora</th><th>Sal√≥n</th><th>Evento</th><th>Conserje</th><th>Estado</th><th></th>
        </tr>
      </thead>
      <tbody>${rows}</tbody>
    </table>
    </div>`;

  // Wire: cancelar por token con motivo
  el.querySelectorAll('.btn-cancel').forEach(btn=>{
    btn.onclick = ()=>{
      const token = btn.dataset.token || '';
      if (!token) return;
      const estadoBtn = String(btn.dataset.estado||'').toUpperCase();
      const motivo = prompt('Motivo de cancelaci√≥n:', estadoBtn==='PENDIENTE' ? 'Cancelada por el solicitante (pendiente)' : '');
      if (motivo===null) return; // cancel√≥ el prompt
      const m = String(motivo||'').trim();
      if (!m){ return modal('Debes indicar un motivo.'); }
      Busy.show('Cancelando‚Ä¶');
      google.script.run
        .withSuccessHandler(r=>{
          Busy.hide();
          if (!r || !r.ok){ return modal((r&&r.msg)||'No se pudo cancelar'); }
          modal('Reserva cancelada. Se envi√≥ un correo de confirmaci√≥n.');
          listar(); // refresca tabla
        })
        .withFailureHandler(()=>{ Busy.hide(); modal('Error al cancelar'); })
        .apiCancelarReservaByToken(token, m);
    };
  });
}

function listar(){
  const f1 = $('#df1').value || '';
  const f2 = $('#df2').value || '';
  const email = ME.email || '';
  Busy.show('Cargando mis reservas‚Ä¶');
  google.script.run
    .withSuccessHandler(r=>{
      Busy.hide();
      try{
        const res = normalizeRes(r);
        const arr = (res && Array.isArray(res.data)) ? res.data : [];
        console.log('[MIS] response:', res);
        console.log('[MIS] data length:', arr.length);
        drawMisReservas(arr);
      }catch(e){
        console.error('[MIS] parse error:', e, r);
        drawMisReservas([]); // mostrar√° mensaje amigable
      }
    })
    .withFailureHandler(e=>{
      Busy.hide();
      console.error('[MIS] RPC error:', e);
      modal('No se pudieron cargar tus reservas');
      drawMisReservas([]);
    })
    .apiListMisReservasByEmail(f1, f2, email);
}

/* ===== Init ===== */
function init(){
  Busy.reset();
  $('#logo').src = (window.__LOGO_URL__ || '');
  console.log('[BOOT] ME:', ME);

  const today = new Date();
  const y = today.getFullYear(), m = today.getMonth()+1;
  const d = String(today.getDate()).padStart(2,'0');
  const ym = String(m).padStart(2,'0');

  // ===== Toggle anfitri√≥n (por defecto: ‚ÄúS√≠‚Äù ‚Üí autollenar con BD de sesi√≥n) =====
  (function(){
    const btnYes = document.getElementById('hostYes');
    const btnNo  = document.getElementById('hostNo');
    const fields = {
      nombre: document.getElementById('nombre'),
      email:  document.getElementById('email'),
      dep:    document.getElementById('depto'),
      ext:    document.getElementById('ext'),
    };
    function fillFromME(){
      if (fields.nombre) fields.nombre.value = (ME.nombre||'').trim();
      if (fields.email)  fields.email.value  = (ME.email||'').trim();
      if (fields.dep)    fields.dep.value    = (ME.departamento||'').trim();
      if (fields.ext)    fields.ext.value    = (ME.extension||'');
    }
    function clearHost(){
      Object.values(fields).forEach(el=>{ if (el) el.value=''; });
      const eHint = document.getElementById('emailError'); if (eHint) eHint.hidden = true;
      const xHint = document.getElementById('extError');   if (xHint) xHint.hidden = true;
    }
    function setPressed(yes){
      btnYes.setAttribute('aria-pressed', yes?'true':'false');
      btnNo.setAttribute('aria-pressed',  yes?'false':'true');
    }
    if (btnYes && btnNo){
      btnYes.onclick = ()=>{ setPressed(true); fillFromME(); };
      btnNo.onclick  = ()=>{ setPressed(false); clearHost(); };
      // default: s√≠
      setPressed(true); fillFromME();
    }
  })();

  // ===== Validaci√≥n de dominio en email (@infotep.gob.do) =====
  (function(){
    const email = document.getElementById('email');
    const hint  = document.getElementById('emailError');
    const okDom = (v)=> /@infotep\.gob\.do$/i.test(String(v||'').trim());
    if (!email || !hint) return;
    email.addEventListener('blur', ()=>{
      const v = email.value;
      hint.hidden = !v || okDom(v);
    });
  })();

  // ===== Reserva: fecha m√≠nima = hoy (evita fechas pasadas) =====
  const todayYMD = `${y}-${ym}-${d}`;
  const $fecha = $('#fecha');
  if ($fecha){
    $fecha.min = todayYMD; // bloquea selecci√≥n anterior a hoy
    $fecha.value = todayYMD; // valor inicial
    $fecha.addEventListener('change', ()=>{
      if ($fecha.value && $fecha.value < $fecha.min){
        $fecha.value = $fecha.min; // corrige si teclean manualmente una fecha pasada
      }
    });
  }

  // ===== Mis reservas: sincronizaci√≥n de rango =====
  const $df1 = $('#df1');
  const $df2 = $('#df2');
  if ($df1 && $df2){
    // hoy ‚Üí hoy + 30 d√≠as
    const addDays = (base, days)=> {
      const t = new Date(base.getFullYear(), base.getMonth(), base.getDate());
      t.setDate(t.getDate() + days);
      const yy = t.getFullYear();
      const mm = String(t.getMonth()+1).padStart(2,'0');
      const dd = String(t.getDate()).padStart(2,'0');
      return `${yy}-${mm}-${dd}`;
    };
    const start = `${y}-${ym}-${d}`;
    const end   = addDays(today, 30);
    $df1.value = start;
    $df2.value = end;
    // l√≠mites coherentes
    const syncRange = ()=>{
      if ($df1.value){ $df2.min = $df1.value; }
      if ($df2.value){ $df1.max = $df2.value; }
    };
    $df1.addEventListener('change', ()=>{
      if ($df2.value && $df2.value < $df1.value) $df2.value = $df1.value;
      syncRange();
    });
    $df2.addEventListener('change', ()=>{
      if ($df1.value && $df1.value > $df2.value) $df1.value = $df2.value;
      syncRange();
    });
    syncRange();
  }

  loadSalones();
  listar();

  $('#selSalon').onchange = scheduleRefreshSlots;
  // Tambi√©n, al cambiar de sal√≥n, limpiar/volver a evaluar el error de capacidad
  $('#selSalon').addEventListener('change', ()=>{
    const cap = (window.__SALON_CAPS__||{})[$('#selSalon').value||''] || 0;
    const n = Number(($('#cant').value||''));
    const bad = cap && n>cap;
    const capErr = document.getElementById('cantError');
    if (capErr){
      capErr.hidden = !bad;
      capErr.textContent = bad ? `La cantidad ingresada excede la capacidad m√°xima (${cap}).` : '';
    }
    $('#cant').classList.toggle('input-error', bad);
  });
  $('#fecha').onchange    = scheduleRefreshSlots;
  $('#dur').onchange      = scheduleRefreshSlots;
  $('#btnCrear').onclick  = reservar;
  $('#btnFiltrar').onclick= listar;
  $('#hora').onchange     = verifySelectedSlot;
  $('#cant').addEventListener('input', validateCapacityHint);
  $('#selSalon').addEventListener('change', validateCapacityHint);

  // Extensi√≥n: mostrar hint SOLO cuando el usuario intenta teclear algo no num√©rico
  const ext = $('#ext'), extErr = $('#extError');

  // Validaci√≥n din√°mica de capacidad mientras escribe
  const cant = $('#cant');
  if (cant){
    cant.addEventListener('input', ()=>{
      const salonId = $('#selSalon').value || '';
      const cap = (window.__SALON_CAPS__||{})[salonId] || 0;
      const n = Number(cant.value||0);
      const bad = cap && n>cap;
      let capErr = document.getElementById('cantError');
      if (!capErr){
        // Crea el hint rojo si no existe
        capErr = document.createElement('small');
        capErr.id = 'cantError';
        capErr.className = 'error';
        cap.insertAdjacentElement ? cant.insertAdjacentElement('afterend', capErr) : cant.parentNode.appendChild(capErr);
      }
      capErr.hidden = !bad;
      capErr.textContent = bad ? `La cantidad ingresada excede la capacidad m√°xima (${cap}).` : '';
      cant.classList.toggle('input-error', bad);
    });
  }

  if (ext){
    ext.addEventListener('input', (e)=>{
      const before = e.target.value;
      const after  = before.replace(/\D+/g,'');   // dejamos solo d√≠gitos
      const bad    = before !== after;            // hubo intento de car√°cter inv√°lido
      if (bad){
        e.target.value = after;                   // sanitiza
        clearTimeout(__extHintTimer__);
        extErr.hidden = false;                    // muestra hint solo por el intento
        e.target.classList.add('input-error');
        __extHintTimer__ = setTimeout(()=>{
          extErr.hidden = true;                   // oculta autom√°ticamente
          e.target.classList.remove('input-error');
        }, 1200);
      }else{
        // si el usuario est√° tecleando n√∫meros v√°lidos, mant√©n el hint oculto
        // y quita la clase de error si estuviera
        extErr.hidden = true;
        e.target.classList.remove('input-error');
      }
    });
  }

  const btnRefresh = $('#btnRefreshSlots');

  if (btnRefresh){
    btnRefresh.onclick = () => {
      scheduleRefreshSlots();
    };
  }

  // Capacidad: ocultar hint si corrigen o cambian sal√≥n
  (function(){
    const cant = document.getElementById('cant');
    const err  = document.getElementById('cantError');
    const sel  = document.getElementById('selSalon');
    const hide = ()=>{ if (err) err.hidden = true; };
    if (cant){ cant.addEventListener('input', ()=>{ if (!cant.value) hide(); }); }
    if (sel){ sel.addEventListener('change', hide); }
    hide();
  })();

  const out = s => document.getElementById('dbgOut').textContent = s || '';

  const btnDump  = document.getElementById('btnDump');
  const btnCheck = document.getElementById('btnCheck');

  if (btnDump){
    btnDump.onclick = () => {
      const salonId = $('#selSalon').value || '';
      const fecha   = $('#fecha').value || '';
      const dur     = Number($('#dur').value || 0);
      Busy.show('Dump server‚Ä¶');
      google.script.run
        .withSuccessHandler(r => { Busy.hide(); out(JSON.stringify(r, null, 2)); console.log('[DBG] dump:', r); })
        .withFailureHandler(e => { Busy.hide(); out('Error dump'); })
        .dbg_AvailabilityDump(fecha, salonId, dur);
    };
  }
  if (btnCheck){
    btnCheck.onclick = () => {
      const salonId = $('#selSalon').value || '';
      const fecha   = $('#fecha').value || '';
      const dur     = Number($('#dur').value || 0);
      const inicio  = $('#hora').value || '';
      Busy.show('Check create‚Ä¶');
      google.script.run
        .withSuccessHandler(r => { Busy.hide(); out(JSON.stringify(r, null, 2)); console.log('[DBG] check:', r); })
        .withFailureHandler(e => { Busy.hide(); out('Error check'); })
        .dbg_CheckCreate(fecha, salonId, inicio, dur);
    };
  }
}
document.addEventListener('DOMContentLoaded', init);

/* ===== Duraci√≥n desde Config ===== */
function getDurationConfigForSalon(salonId){
  const cfg = (__SALON_CFG__||{})[salonId];
  if (!cfg) return { ...DEFAULT_DUR_CFG_PUBLIC };
  return {
    min: Number(cfg.duracion_min || DEFAULT_DUR_CFG_PUBLIC.min),
    max: Number(cfg.duracion_max || DEFAULT_DUR_CFG_PUBLIC.max),
    step: Number(cfg.duracion_step || DEFAULT_DUR_CFG_PUBLIC.step)
  };
}

function renderDurationsFromConfig(){
  const sel = $('#dur');
  if (!sel) return;
  const salonId = ($('#selSalon') && $('#selSalon').value) || '';
  const cfg = getDurationConfigForSalon(salonId);
  const min = Math.max(1, Number(cfg.min || DEFAULT_DUR_CFG_PUBLIC.min));
  const max = Math.max(min, Number(cfg.max || min));
  const step = Math.max(1, Number(cfg.step || DEFAULT_DUR_CFG_PUBLIC.step));
  const opts = ['<option value="">[Seleccionar]</option>'];
  for (let d=min; d<=max; d+=step){
    const label = humanizeMinutes(d);
    opts.push(`<option value="${d}">${label}</option>`);
  }
  sel.innerHTML = opts.join('');
  sel.value = '';
}
function humanizeMinutes(mins){
  if (mins < 60) return `${mins} minutos`;
  const h = Math.floor(mins/60), m = mins % 60;
  if (m === 0) return `${h} ${h===1?'hora':'horas'}`;
  return `${h} ${h===1?'hora':'horas'} ${m} min`;
}

/* ===== Hint de capacidad ===== */
function validateCapacityHint(){
  const salonId = $('#selSalon').value || '';
  const raw     = String($('#cant').value || '').trim();
  const cant    = Number(raw || 0);
  const errEl   = $('#cantError');
  const lblMax  = $('#cantMax');
  // Actualiza el "(m√°x X)" en el label cuando exista sal√≥n con capacidad
  const salon = (__SALONES__||[]).find(s => String(s.id) === String(salonId));
  const cap   = salon && Number(salon.capacidad) ? Number(salon.capacidad) : null;
  if (lblMax){
    lblMax.textContent = cap ? `(m√°x ${cap})` : '';
  }
  // Si no hay sal√≥n, no hay capacidad; si el campo est√° vac√≠o, ocultar hint
  if (!cap || raw === ''){
    errEl.hidden = true;
    return;
  }
  if (cant > cap){
    errEl.textContent = `La cantidad ingresada excede la capacidad m√°xima (${cap}).`;
    errEl.hidden = false;
  }else{
    errEl.hidden = true;
  }
}

// Actualiza el "(m√°x X)" y revalida cada vez que cambie el sal√≥n
$('#selSalon').addEventListener('change', validateCapacityHint);

// Revalida al escribir, cambiar o salir del campo (cubre m√°s navegadores)
$('#cant').addEventListener('input',  validateCapacityHint);
$('#cant').addEventListener('change', validateCapacityHint);
$('#cant').addEventListener('blur',   validateCapacityHint);
</script>
